/// @ 0.19.0
// ãŠã¾ãˆã‚“ã¡
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/`
let PLAY_TAG = "#KITAZAWA_HOUSE"
let PLAY_ID = if exists THIS_ID THIS_ID else PLAY_URL

let random = eval {
  let id = if exists USER_ID USER_ID else Util:uuid()
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ä»Šæ—¥ã®æ—¥ä»˜ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
//  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}`)
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ãƒŸãƒªç§’ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}-{Date:minute()}-{Date:second()}-{Date:millisecond()}`)
}

// é™¤å¤–ã™ã‚‹çµµæ–‡å­—ã®ã‚«ãƒ†ã‚´ãƒª
// pagesã®jsonãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// https://{SERVER_URL}/@elysion/pages/ignore_emoji_data
let IGNORE_EMOJI_LIST = eval {
  var data = null
  let pages_data = Mk:api("pages/show", {
    name: "ignore_emoji_data"
    username: "elysion"
  })
  if (Core:type(pages_data) == "error") {
    data = {
      category: [
        null
      ]
    }
  } else {
    data = Json:parse(pages_data.content[0].text)
  }
  data
}

// ããŸã–ã‚ã‚“ã¡ã§ä½¿ç”¨ã™ã‚‹çµµæ–‡å­—ã‚„ã‚«ãƒ†ã‚´ãƒª
// pagesã®jsonãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// https://{SERVER_URL}/@elysion/pages/kitazawa_house_data
let EMOJI_LIST = eval {
  var data = null
  let pages_data = Mk:api("pages/show", {
    name: "kitazawa_house_data"
    username: "elysion"
  })
  if (Core:type(pages_data) == "error") {
    Core:abort([
      `pagesã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`
      `{SERVER_URL}/@elysion/pages/kitazawa_house_data`
      `ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚`
    ].join(Str:lf))
  } else {
    data = Json:parse(pages_data.content[0].text)
  }
  data
}

@EmojiManager() {
  let this = {
    obj: {}
    categories: []
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    constructor: @() {
      // é™¤å¤–ã‚«ãƒ†ã‚´ãƒªä»¥å¤–ã®çµµæ–‡å­—æŠ½å‡º
      this.obj = CUSTOM_EMOJIS.filter(@(emoji) {
        !IGNORE_EMOJI_LIST.category.incl(emoji.category)
      })
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼æŠ½å‡º
      var prev_category = ""
      for (let i = 0, (this.obj.len - 1)) {
        if (prev_category != this.obj[i].category) {
          this.categories.push(this.obj[i].category)
        }
        prev_category = this.obj[i].category
      }
      this
    }
    // çµµæ–‡å­—ã‚’è¿”ã™
    // param: name<str>
    // return: <arr>
    getEmoji: @(name) {
      this.obj.filter(@(v) {
        (v.name == name)
      }).pop()
    }
    // ãƒ©ãƒ³ãƒ€ãƒ ãªçµµæ–‡å­—ã‚’è¿”ã™
    // return: <obj>
    getRandomEmoji: @() {
      this.obj[random(0, (this.obj.len - 1))]
    }
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã®çµµæ–‡å­—ã‚’è¿”ã™
    // param: category<str>
    // return: <arr>
    getCategoryEmojis: @(category) {
      this.obj.filter(@(emoji) {
        emoji.category == category
      })
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
    // param: emoji<obj>
    // return: <arr>
    getEmojiAliases: @(emoji) {
      var aliases = []
      // çµµæ–‡å­—è¿½åŠ ç›´å¾Œã¯aliasesã«ä½•ã‚‚å…¥ã£ã¦ã„ãªã„å ´åˆãŒã‚ã‚‹
      if (emoji["aliases"].len > 0) {
        // ""ã®å ´åˆ
        if (emoji["aliases"][0] == "") {
          // emoji.nameã‚’è¿”ã™
          aliases.push(emoji["name"])
        } else {
          // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
          aliases = emoji["aliases"]
        }
      } else {
        // emoji.nameã‚’è¿”ã™
        aliases.push(emoji["name"])
      }
      aliases
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™(fRand = trueã§ãƒ©ãƒ³ãƒ€ãƒ )
    // param: emoji<obj>
    // param: fRand<bool>
    // return: <str>
    getEmojiAliase: @(emoji, fRand) {
      var aliase = ""
      var aliases = this.getEmojiAliases(emoji)
      if (fRand) {
        // ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
        aliase = aliases[random(0, (aliases.len - 1))]
      } else {
        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å…ˆé ­ã‚’è¿”ã™
        aliase = aliases[0]
      }
      aliase
    }
  }
  this.constructor()
}

// æ™‚è¨ˆ[0åˆ†,30åˆ†]
let CLOCK_EMOJIS = [
  ["ğŸ•›", "ğŸ•§"],
  ["ğŸ•", "ğŸ•œ"],
  ["ğŸ•‘", "ğŸ•"],
  ["ğŸ•’", "ğŸ•"],
  ["ğŸ•“", "ğŸ•Ÿ"],
  ["ğŸ•”", "ğŸ• "],
  ["ğŸ••", "ğŸ•¡"],
  ["ğŸ•–", "ğŸ•¢"],
  ["ğŸ•—", "ğŸ•£"],
  ["ğŸ•˜", "ğŸ•¤"],
  ["ğŸ•™", "ğŸ•¥"],
  ["ğŸ•š", "ğŸ•¦"]
]

@Game() {
  var render_components = []
  var emojiMng = null
  var house_data = {}
  
  var mimichans = []
  var friends = []
  var tv_mojis = []
  var visitors = []
  var data_components = []

  // åˆæœŸåŒ–
  @init() {
    mimichans = []
    friends = []
    tv_mojis = []
    visitors = []
    data_components = []
    
    house_data = Mk:load(`@{USER_ID}/house_data`)
    if (house_data == null) {
      house_data = {
        mimi: "mimi_oshiri"
        friend: "owan"
        tv: "oshiri"
        visitor: "nibimimi_1"
      }
    }
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    emojiMng = EmojiManager()
    
    // ã¿ã¿ã¡ã‚ƒã‚“
    mimichans = emojiMng.getCategoryEmojis("ã®ã‚“ã³ã‚Šã·ã‚‰ã„ã™").filter(@(v) {
      v.name.incl("mimi_")
    }).map(@(v) {
      `$[clickable.ev={v.name} :{v.name}:]`
    })
    // ãƒˆãƒ¢ãƒ€ãƒ
    friends = []
    each (let c, EMOJI_LIST.friends_categories) {
      friends = friends.concat(emojiMng.getCategoryEmojis(c).map(@(v) {
        `$[clickable.ev={v.name} :{v.name}:]`
      }))
    }
    // ãƒ†ãƒ¬ãƒ“ç”»é¢
    tv_mojis = emojiMng.getCategoryEmojis("moji").map(@(v) {
      `$[clickable.ev={v.name} :{v.name}:]`
    })
    // æ¥è¨ªè€…
    visitors = EMOJI_LIST.visitor_emojis.map(@(v) {
      `$[clickable.ev={v.replace(":", "")} {v}]`
    })

    data_components.push(
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:mfm({
                text: [
                  `<small>çµµæ–‡å­—ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</small>`
                  mimichans.join()
                ].join(Str:lf)
                onClickEv: @(e) {
                  house_data.mimi = e
                  main()
                }
              })
            ]
            title: `ç´ æ: ã¿ã¿ã¡ã‚ƒã‚“({mimichans.len})`
            opened: false
          })
        ]
        align: "center"
        padding: 5
      })
    )
    data_components.push(
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:mfm({
                text: [
                  `<small>çµµæ–‡å­—ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</small>`
                  friends.join()
                ].join(Str:lf)
                onClickEv: @(e) {
                  house_data.friend = e
                  main()
                }
              })
              Ui:C:button({
                onClick: @() {
                  house_data.friend = "tp"
                  main()
                }
                text: "èª°ã‚‚è¡¨ç¤ºã•ã›ãªã„"
              })
            ]
            title: `ç´ æ: ãƒˆãƒ¢ãƒ€ãƒ({friends.len})`
            opened: false
          })
        ]
        align: "center"
        padding: 5
      })
    )
    data_components.push(
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:mfm({
                text: [
                  `<small>çµµæ–‡å­—ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</small>`
                  tv_mojis.join()
                ].join(Str:lf)
                onClickEv: @(e) {
                  house_data.tv = e
                  main()
                }
              })
              Ui:C:button({
                onClick: @() {
                  house_data.tv = "tp"
                  main()
                }
                text: "ä½•ã‚‚è¡¨ç¤ºã•ã›ãªã„"
              })
            ]
            title: `ç´ æ: ãƒ†ãƒ¬ãƒ“ç”»é¢({tv_mojis.len})`
            opened: false
          })
        ]
        align: "center"
        padding: 5
      })
    )
    data_components.push(
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:mfm({
                text: [
                  `<small>çµµæ–‡å­—ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</small>`
                  visitors.join()
                ].join(Str:lf)
                onClickEv: @(e) {
                  house_data.visitor = e
                  main()
                }
              })
              Ui:C:button({
                onClick: @() {
                  house_data.visitor = "tp"
                  main()
                }
                text: "èª°ã‚‚è¡¨ç¤ºã•ã›ãªã„"
              })
            ]
            title: `ç´ æ: æ¥è¨ªè€…({visitors.len})`
            opened: false
          })
        ]
        align: "center"
        padding: 5
      })
    )

    main()
  }
  // æ™‚è¨ˆ(30åˆ†æ¯)
  // param: colors<arr>
  @getClock() {
    var clock = ""
    if (Date:minute() >= 30) {
      clock = CLOCK_EMOJIS[(Date:hour() % 12)][1]
    } else {
      clock = CLOCK_EMOJIS[(Date:hour() % 12)][0]
    } 
    clock
  }
  // çª“ã‹ã‚‰è¦‹ãˆã‚‹ç©ºã®è‰²å–å¾—(3æ™‚é–“ãŠã)
  // param: colors<arr>
  // [åŸºæœ¬è‰², æ¿ƒæ·¡è‰²]
  @getSkyColors() {
    var colors = ""
    match true {
      // æ¼†é»’
      (Date:hour() >= 0 && 3 > Date:hour()) => {
        colors = [ "000030", "000000" ]
      }
      // è¤è¿”
      (Date:hour() >= 3 && 6 > Date:hour()) => {
        colors = [ "203744", "0E191F" ]
      }
      // ç™½è—
      (Date:hour() >= 6 && 9 > Date:hour()) => {
        colors = [ "C1E4E9", "74C2CC" ]
      }
      // ç©ºè‰²
      (Date:hour() >= 9 && 12 > Date:hour()) => {
        colors = [ "A0D8EF", "47B4DF" ]
      }
      // ç©ºè‰²
      (Date:hour() >= 12 && 15 > Date:hour()) => {
        colors = [ "87CEEB", "2DAADB" ]
      }
      // ç´…æ›ç©ºè‰²
      (Date:hour() >= 15 && 18 > Date:hour()) => {
        colors = [ "8491C3", "4A5A96" ]
      }
      // æ¿ƒè—
      (Date:hour() >= 18 && 21 > Date:hour()) => {
        colors = [ "0F2350", "060F22" ]
      }
      // é‰„ç´º
      (Date:hour() >= 21 && 24 > Date:hour()) => {
        colors = [ "17184B", "0A0B23" ]
      }
    }
    colors
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    render_components = []
    render_components.push(
      Ui:C:container({
        children: data_components
        align: "center"
      })
    )
    // ç©ºã®è‰²
    let sky_colors = getSkyColors()
    
    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `$[position.x=-1,y=4 $[scale.x=4,y=2 $[scale.x=1.5,y=2  $[border.width=4,style=inset,color=abc2bb $[bg.color=71ab99 :tp:]]]]]`
      `$[position.x=2,y=0 $[scale.x=2,y=2 {getClock()}]]$[position  $[position.x=5 $[border.color=D89E83,width=2,style=inset $[position $[scale $[rotate $[bg.color={sky_colors[0]} :tp:]]]]]]$[position.x=5 $[bg.color={sky_colors[0]} $[border.color=D89E83,width=2,style=inset $[position.x=1,y=1 $[scale.x=1.5,y=1.5 $[rotate.deg=45 $[bg.color={sky_colors[1]} :tp:]]]]]]]$[position.x=0.4,y=2.3 $[bg.color={sky_colors[0]} $[border.color=D89E83,width=2,style=inset $[position.x=1,y=1 $[scale.x=1.5,y=1.5 $[rotate.deg=45 $[bg.color={sky_colors[1]} :tp:]]]]]]]$[position.x=0.4,y=2.3 $[border.color=D89E83,width=2,style=inset $[position $[scale $[rotate.deg=0 $[bg.color={sky_colors[1]} :tp:]]]]]]]$[position.x=-1.575,y=2.25 $[scale.x=1.2,y=1.2 <small>:{house_data.visitor}:</small>]]`
      `$[position.x=-2.6,y=2 $[scale.x=3,y=3 ğŸ“º]]$[position.x=-4.2,y=2.1 $[scale.x=0.9,y=0.9 $[rainbow.speed=10s :{house_data.tv}:]]]`
      `$[position.x=2,y=1 $[scale.x=1.5,y=1.5 :{house_data.friend}:]]$[position.x=3,y=1 $[scale.x=1.5,y=1.5 :{house_data.mimi}:]]`
      `:tp:`
    ].join(Str:lf)
    
    render_components.push(
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:mfm({
                    text: resultMfm
                  })
                  Ui:C:postFormButton({
                    text: "æŠ•ç¨¿ã™ã‚‹"
                    form: {
                      text: [
                        `<center>`
                        resultMfm
                        PLAY_URL
                        PLAY_TAG
                        `</center>`
                      ].join(Str:lf)
                    }
                    primary: true
                    rounded: true
                  })
                  Ui:C:button({
                    onClick: @() {
                      if Mk:confirm("ç¢ºèª", [
                        "åˆæœŸè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"
                        "$[x2 :majikaw::mimi_hate:]"
                      ].join(Str:lf), "warning") {
                        Mk:save(`@{USER_ID}/house_data`, null)
                        init()
                      }
                    }
                    text: "åˆæœŸè¨­å®šã«æˆ»ã™"
                  })
                ]
              })
            ]
            title: "çµæœ"
          })
        ]
        align: "center"
      })
    )
    render(render_components)
    Mk:save(`@{USER_ID}/house_data`, house_data)
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
