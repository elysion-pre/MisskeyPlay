/// @ 0.19.0
// ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_NAME = "ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS"
let PLAY_TAG = "#ore_no_atsu_atsu_kiss"
let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/9rn1fjsb6j`

let RANK_EMOJI = [
  "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ"
]

@Game() {
  var input_id = ""
  var fBotExclusion = false
  var fLocalOnly = false
  // åˆæœŸåŒ–
  @init() {
    if USER_ID == null {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      input_id = USER_ID
      render([
        Ui:C:container({
          children: [
            Ui:C:textInput({
              onInput: @(text) {
                input_id = text
              }
              default: input_id
              label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
              caption: "âš ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèªæ–¹æ³•: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«â†’rawã‚¿ãƒ–"
            })
          ]
        })
        Ui:C:folder({
          children: [
            Ui:C:switch({
              onChange: @(enabled) {
                fBotExclusion = enabled
              }
              default: false
              label: "boté™¤å¤–"
              caption: "âš ï¸ONã«ã™ã‚‹ã¨botã¯å¯¾è±¡å¤–"
            })
            Ui:C:switch({
              onChange: @(enabled) {
                fLocalOnly = enabled
              }
              default: false
              label: "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿"
              caption: "âš ï¸ONã«ã™ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå¯¾è±¡"
            })
          ]
          title: "ã‚ªãƒ—ã‚·ãƒ§ãƒ³"
        })
        Ui:C:container({
          children: [
            Ui:C:button({
              onClick: main
              text: "ç¢ºèªã™ã‚‹"
              primary: true
            })
          ]
          align: "center"
        })
      ])
    }
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `é »ç¹ã«ãƒªãƒ—ãƒ©ã‚¤(è¿”ä¿¡)ã‚’ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
              `<small>æœ€æ–°ã®1000ä»¶ã®ãƒãƒ¼ãƒˆã‚’å¯¾è±¡ã«é›†è¨ˆã‚’è¡Œã„ã¾ã™</small>`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé »ç¹ã«ãƒªãƒ—ãƒ©ã‚¤(è¿”ä¿¡)ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚
    // æœ€æ–°ã®1000ä»¶ã®ãƒãƒ¼ãƒˆã‚’å¯¾è±¡ã«é›†è¨ˆã‚’è¡Œã„ã¾ã™ã€‚
    let replied_users = Mk:api("users/get-frequently-replied-users", {
      userId: input_id,
      limit: 100
    })
    
    var count = 0
    let ranking_list = []
    let not_ranked_list = []
    if replied_users.len > 0 {
      each (let user_data, replied_users) {
        // å‡çµã¯é™¤å¤–
        if user_data.user.isSuspended continue
        // boté™¤å¤–
        if fBotExclusion && user_data.user.isBot continue
        // è‡ªèº«ã¯é™¤å¤–
        if user_data.user.id == input_id continue
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿
        if fLocalOnly && user_data.user.host != null continue

        // 1ä½ã‹ã‚‰10ä½
        if count < 10 {
          if count == 0 {
            ranking_list.push(`$[jelly {RANK_EMOJI[count]}: ?[<plain>{if user_data.user.name == null user_data.user.username else user_data.user.name}</plain>]({SERVER_URL}/@{user_data.user.username}{if user_data.user.host != null `@{user_data.user.host}` else ""})]`)
          } else {
            ranking_list.push(`{RANK_EMOJI[count]}: ?[<plain>{if user_data.user.name == null user_data.user.username else user_data.user.name}</plain>]({SERVER_URL}/@{user_data.user.username}{if user_data.user.host != null `@{user_data.user.host}` else ""})`)
          }
          count += 1
        } else {
          // 11ä½ä»¥é™
          not_ranked_list.push(`{count + 1}: ?[<plain>{if user_data.user.name == null user_data.user.username else user_data.user.name}</plain>]({SERVER_URL}/@{user_data.user.username}{if user_data.user.host != null `@{user_data.user.host}` else ""})`)
          count += 1
        } 
      }
      if fBotExclusion {
        if fLocalOnly {
          ranking_list.push("<small>boté™¤å¤–, ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿</small>")
        } else {
          ranking_list.push("<small>boté™¤å¤–</small>")
        }
      } else {
        if fLocalOnly {
          ranking_list.push("<small>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿</small>")
        }
      }

      // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let postText = [
        `<plain>{if USER_NAME != null USER_NAME else USER_USERNAME}</plain>ã®{PLAY_NAME}ã¯`
        ranking_list.join(Str:lf)
        PLAY_TAG
        PLAY_URL
      ].join(Str:lf)
      
      let render_components = []
      render_components.push(
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: ranking_list.join(Str:lf)
            })
          ]
        })
      )
      // å¯¾è±¡ãŒè‡ªåˆ†ãªã‚‰æŠ•ç¨¿å¯èƒ½
      if input_id == USER_ID {
        render_components.push(
          Ui:C:container({
            children: [
              Ui:C:postFormButton({
                text: "æŠ•ç¨¿ã™ã‚‹"
                form: {
                  text: postText
                }
                primary: true
                rounded: true
              })
            ]
            align: "center"
          })
        )
      }
      render_components.push(
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: not_ranked_list.join(Str:lf)
                })
              ]
              title: "11ä½ä»¥é™ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°"
            })
          ]
        })
      )
      render(render_components)
    } else {

      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        "ç›´è¿‘1000ä»¶ã®ãƒãƒ¼ãƒˆå†…ã«ãƒªãƒ—ãƒ©ã‚¤(è¿”ä¿¡)ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        `$[x2 :kanashiiyo::mimi_hate:]`
        `ãŸãã•ã‚“ãƒªãƒ—ãƒ©ã‚¤ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    }
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
