/// @ 0.19.0
// ããŸã–ã‚ãƒãƒ¼ãƒ„ãƒ©ãƒ³ã‚­ãƒ³ã‚°
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/a2e7hul6sw`
let PLAY_TAG = "#KITAZAWA_NOTES_RANKING"
let PLAY_ID = if exists THIS_ID THIS_ID else PLAY_URL

let RANK_EMOJI = [
  "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ"
]

@Game() {
  var users = []

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®é…åˆ—å†…ã®ç‰¹å®šã®idãŒä¸€è‡´ã™ã‚‹é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å–å¾—
  // param: arr<arr>
  // param: targetId<str>
  // return: <num>
  @findIndexById(arr, targetId) {
    var index = -1
    var i = 0
    each (let obj, arr) {
      if obj.id == targetId {
        index = i
        break
      }
      i += 1
    }
    return index
  }
  @init() {
    users = []
    
    if USER_ID == null {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      main()
    }
  }
  @main() {
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
              `<small>âš ï¸èª­ã¿è¾¼ã¿æ™‚é–“ã¯ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã«æ¯”ä¾‹</small>`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    loop {
      let works = Mk:api("users", {
        limit: 100
        offset: users.len
      })
      if works.len == 0 break

      users = users.concat(works)
      if (works.len < 100) break
    }
    // notesCountãŒå¤šã„é †ã§ã‚½ãƒ¼ãƒˆ
    users.sort(@(a, b) {
      (b.notesCount - a.notesCount)
    })

    let index = findIndexById(users, USER_ID)

    var count = 0
    let ranking_list = []
    if users.len > 0 {
      each (let user, users) {
        var mfm = ""
        // 1ä½ã‹ã‚‰10ä½
        if count < 10 {
          mfm = `{RANK_EMOJI[count]}: ?[<plain>{if user.name == null user.username else user.name}</plain>]({SERVER_URL}/@{user.username}{if user.host != null `@{user.host}` else ""}), {user.notesCount}`
          count += 1
        } else {
          // 11ä½ä»¥é™
          mfm = `{count + 1}: ?[<plain>{if user.name == null user.username else user.name}</plain>]({SERVER_URL}/@{user.username}{if user.host != null `@{user.host}` else ""}), {user.notesCount}`
          count += 1
        }
        if user.id == USER_ID mfm = ["$[jelly " mfm "]"].join()
        ranking_list.push(mfm)

        if count > 99 break
      }
    }

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `<plain>{if USER_NAME == null USER_USERNAME else USER_NAME}</plain>ã®ãƒãƒ¼ãƒ„æ•°ã¯`
      `$[fg.color=f00 ***{index + 1}***]ä½`
      `<small>{index + 1}/{users.len}äºº</small>`
      `<small>{users[index].notesCount}ãƒãƒ¼ãƒ„</small>`
    ].join(Str:lf)

    // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    let postText = [
      `<center>`
      `<plain>{if USER_NAME == null USER_USERNAME else USER_NAME}</plain>ã®ãƒãƒ¼ãƒ„æ•°ã¯`
      `$[fg.color=f00 ***{index + 1}***]ä½`
      PLAY_URL
      PLAY_TAG
      `</center>`
    ].join(Str:lf)
    
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: resultMfm
          })
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: postText
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:mfm({
                text: ranking_list.join(Str:lf)
              })
            ]
            title: "ãƒãƒ¼ãƒ„ãƒ©ãƒ³ã‚­ãƒ³ã‚°(100ä½ã¾ã§)"
          })
        ]
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
