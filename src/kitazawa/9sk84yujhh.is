/// @ 0.18.0
// ä»Šæ—¥ã®ã®ã³ã¿ã¿ã¡ã‚ƒã‚“
// Copyright (c) 2024 @elysion
// Released under the MIT license
// https://opensource.org/licenses/mit-license.php

let PLAY_NAME = "ä»Šæ—¥ã®ã®ã³ã¿ã¿ã¡ã‚ƒã‚“"
let TAG_NAME = "#NOBI_MIMICHAN"
let PLAY_URL = if exists THIS_URL THIS_URL else "https://msk.kitazawa.me/play/9sk84yujhh"

let random = eval {
  var id = if exists USER_ID USER_ID else Util:uuid()
  // ã‚·ãƒ¼ãƒ‰ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ä»Šæ—¥ã®æ—¥ä»˜ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
  Math:gen_rng(`{id}-{Date:year()}-{Date:month()}-{Date:day()}`)
  // ã‚·ãƒ¼ãƒ‰ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ãƒŸãƒªç§’ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
//  Math:gen_rng(`{id}-{Date:year()}-{Date:month()}-{Date:day()}-{Date:minute()}-{Date:second()}-{Date:millisecond()}`)
}

:: Arr {
  // ãƒ©ãƒ³ãƒ€ãƒ ã§é…åˆ—ã®å€¤ã‚’è¿”ã™
  // param: array<arr>
  // return: <arr[0~(arr.len - 1)]>
  @randomSelect(array) {
    array[random(0, (array.len - 1))]
  }
  // æŒ‡å®šã®é…åˆ—ã‚’å‰Šé™¤ã—ãŸé…åˆ—ã‚’è¿”ã™
  // param: array<arr>
  // param: index<num>
  // return: <arr>
  @splice(array, index) {
    array.slice(0, index).concat(array.slice((index + 1), array.len))
  }
}

:: Ui {
  // æŒ‡å®šUIã®hiddenå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @hidden(name, f) {
    Ui:get(name).update({
      hidden: f
    })
  }
  // æŒ‡å®šUIã®disabledå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @disabled(name, f) {
    Ui:get(name).update({
      disabled: f
    })
  }
}

@Game() {
  // ç©ºã®è‰²å–å¾—(3æ™‚é–“ãŠã)
  @getSkyColor() {
    var color = ""
    match true {
      // æ¼†é»’
      (Date:hour() >= 0 && 3 > Date:hour()) => {
        color = "000030"
      }
      // è¤è¿”
      (Date:hour() >= 3 && 6 > Date:hour()) => {
        color = "203744"
      }
      // ç™½è—
      (Date:hour() >= 6 && 9 > Date:hour()) => {
        color = "c1e4e9"
      }
      // ç©ºè‰²
      (Date:hour() >= 9 && 12 > Date:hour()) => {
        color = "a0d8ef"
      }
      // ç©ºè‰²
      (Date:hour() >= 12 && 15 > Date:hour()) => {
        color = "87ceeb"
      }
      // ç´…æ›ç©ºè‰²
      (Date:hour() >= 15 && 18 > Date:hour()) => {
        color = "8491c3"
      }
      // æ¿ƒè—
      (Date:hour() >= 18 && 21 > Date:hour()) => {
        color = "0f2350"
      }
      // é‰„ç´º
      (Date:hour() >= 21 && 24 > Date:hour()) => {
        color = "17184b"
      }
    }
    color
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    let max_num = 20
    var mimi_num = random(2, max_num)

    let mimiMfm = []
    // ä¸ŠåŠèº«
    mimiMfm.push(":nibimimi_1:")
    // èƒ´ä½“
    for (mimi_num - 2) {
      mimiMfm.push(":nobimimi_2:")
    }
    // ä¸‹åŠèº«
    mimiMfm.push(":nobimimi_3:")
    // æ®‹ã‚ŠåŸ‹ã‚
    for (max_num - mimi_num) {
      mimiMfm.unshift(":tp:")
    }

    // ã¿ã¿é•·
    let heightMfm = eval {
      var mfm = `{mimi_num}å„„ãŒ–`
      // ã¿ã¿é•·MAXãªã‚‰è£…é£¾
      if (mimi_num == max_num) {
        mfm = `$[sparkle ***{mfm}***]`
      }
      mfm
    }

    // èƒŒæ™¯(æ™‚é–“ã«ã‚ˆã£ã¦å¤‰åŒ–)
    let backgroundMfm = [
      `$[blur `
      `$[position.x=1.0,y=22 $[scale.x=-8,y=-22 $[bg.color={getSkyColor()} :tp:]]]`
      `$[position.x=-1.0,y=44 $[scale.x=-8,y=-2 $[bg.color=bc763c :tp:]]]`
      `]`
    ].join()

    // å¤ªé™½ or æœˆ(æ™‚é–“ã«ã‚ˆã£ã¦å¤‰åŒ–)
    let starMfm = eval {
      var star = ""
      match true {
        (Date:hour() >= 5 && 19 > Date:hour()) => { star = "ğŸŒ" }
        (Date:hour() >= 19 || 5 > Date:hour()) => { star = "ğŸŒ›" }
      }
      star
    }

    // ç©ºã®ãƒ‘ãƒ¼ãƒ„
    let skyPartsMfm = [
      `$[position.x=8,y=0 $[scale.x=2.0,y=2.0 {starMfm}]]`
      `$[position.x=-4,y=6 $[scale.x=2.0,y=2.0 â˜ï¸]]`
      `$[position.x=4,y=12 $[scale.x=2.0,y=2.0 â˜ï¸]]`
      `$[position.x=-4,y=18 $[scale.x=2.0,y=2.0 â˜ï¸]]`
      `$[position.x=4,y=24 $[scale.x=2.0,y=2.0 â˜ï¸]]`
      `$[position.x=-4,y=30 $[scale.x=2.0,y=2.0 â˜ï¸]]`
    ].join()

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `$[x2 {heightMfm}]`
      backgroundMfm
      skyPartsMfm
      `$[position.x=0,y=38 :tp:$[jump $[flip :mimi_warai:]]:tp:$[jump :mimi_warai:]:tp:]`
      `$[position.x=2,y=37.5 $[jump.delay=0.1s $[flip :mimi_ha:]]]:tp:$[position.x=0,y=39 $[jump.delay=0.2s $[flip :mimi_oshiri:]]]:tp:$[position.x=0,y=39 $[jump.delay=0.2s :mimi_oshiri:]]:tp:$[position.x=-2,y=37.5 $[jump.delay=0.1s :mimi_ha:]]`
      `$[position.y=-2 {mimiMfm.join(Str:lf)}]`
    ].join(Str:lf)

    // çµæœè¡¨ç¤ºUIæ›´æ–°
    Ui:get("resultMfm").update({
      text: resultMfm
    })

    // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    let postText = [
      `<center>`
      PLAY_NAME
      resultMfm
      TAG_NAME
      PLAY_URL
      `</center>`
    ].join(Str:lf)

    // æŠ•ç¨¿UIæ›´æ–°
    Ui:get("postFormButton").update({
      text: "æŠ•ç¨¿ã™ã‚‹"
      form: {
        text: postText
      }
      primary: true
      rounded: true
    })

    // UIè¡¨ç¤ºãƒ»éè¡¨ç¤º
    Ui:hidden("loading_area", true)
    Ui:hidden("main_area", false)
    Ui:hidden("post_area", false)
  }
  main()
}

Ui:render([
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 {PLAY_NAME}]`
      }, "titleMfm")
    ]
    align: "center"
  } "title_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 $[bounce Now Loading...]]`
      }, "loadingMfm")
    ]
    align: "center"
  } "loading_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({}, "resultMfm")
    ]
    align: "center"
    hidden: true
  }, "main_area")
  Ui:C:container({
    children: [
      Ui:C:postFormButton({}, "postFormButton")
    ]
    align: "center"
    hidden: true
  }, "post_area")
])
Game()
