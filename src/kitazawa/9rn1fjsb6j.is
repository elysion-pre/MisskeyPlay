/// @ 0.18.0
// ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_NAME = eval {
  match SERVER_URL {
    "https://submarin.online" => { "ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸:kiss:" }
    "https://msk.kitazawa.me" => { "ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS" }
    "https://misskey.stream" => { "ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸:kiss:" }
    * => { `ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS` }
  }
}
let TAG_NAME = "#ore_no_atsu_atsu_kiss"
let PLAY_URL = eval {
  if exists THIS_URL THIS_URL
  else {
    match SERVER_URL {
      "https://submarin.online" => { `{SERVER_URL}/play/9scr3d3ljh` }
      "https://msk.kitazawa.me" => { `{SERVER_URL}/play/9rn1fjsb6j` }
      "https://misskey.stream" => { `{SERVER_URL}/play/9ui0o7j7d12304zk` }
      * => ""
    }
  }
}

:: Arr {
  // ãƒ©ãƒ³ãƒ€ãƒ ã§é…åˆ—ã®å€¤ã‚’è¿”ã™
  // param: array<arr>
  // return: <arr[0~(arr.len - 1)]>
  @randomSelect(array) {
    array[random(0, (array.len - 1))]
  }
  // æŒ‡å®šã®é…åˆ—ã‚’å‰Šé™¤ã—ãŸé…åˆ—ã‚’è¿”ã™
  // param: array<arr>
  // param: index<num>
  // return: <arr>
  @splice(array, index) {
    array.slice(0, index).concat(array.slice((index + 1), array.len))
  }
}

:: Ui {
  // æŒ‡å®šUIã®hiddenå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @hidden(name, f) {
    Ui:get(name).update({
      hidden: f
    })
  }
  // æŒ‡å®šUIã®disabledå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @disabled(name, f) {
    Ui:get(name).update({
      disabled: f
    })
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
// param: id<str>
@User(id) {
  let this = {
    data: null
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    // param: id<str>
    constructor: @(id) {
      this.data = Mk:api("users/show", {
        userId: id
      })
      this
    }
    // idå–å¾—
    // return: id<str>
    getId: @() {
      this.data.id
    }
    // hostå–å¾—
    // return: host<str>
    getHost: @() {
      this.data.host
    }
    // åå‰å–å¾—
    // return: username<str>
    getUsername: @() {
      this.data.username
    }
    // åå‰å–å¾—
    // return: name<str>
    getName: @() {
      // åå‰ãŒæœªå…¥åŠ›ãªã‚‰username(@hoge)ã‚’è¿”ã™
      if (this.data.name == null) {
        return this.getUsername()
      }
      return this.data.name
    }
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³åå–å¾—(@username@host)
    // return: name<str>
    getMentionName: @() {
      match this.getHost() {
        null => { return `@{this.getUsername()}` }
        * => { return `@{this.getUsername()}@{this.getHost()}` }
      }
    }
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLå–å¾—
    // return: name<str>
    getProfileURL: @() {
      match this.getHost() {
        null => { return `{SERVER_URL}/@{this.getUsername()}` }
        * => { return `https://{this.getHost()}/@{this.getUsername()}` }
      }
    }
    // idãŒè‡ªåˆ†ã‹ã©ã†ã‹
    // param: id<str>
    // return: f<bool>
    isYourself: @(id) {
      if (this.data.id == id) {
        return true
      } else {
        return false
      }
    }
  }
  this.constructor(id)
}

@Game() {
  let player = User(USER_ID)

  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    // api: users/get-frequently-replied-users
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé »ç¹ã«ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚æœ€æ–°ã®1000ä»¶ã®ãƒãƒ¼ãƒˆã‚’å¯¾è±¡ã«é›†è¨ˆã‚’è¡Œã„ã¾ã™ã€‚
    // https://legacy.misskey-hub.net/docs/api/endpoints/users/get-frequently-replied-users.html
    let replied_users = Mk:api("users/get-frequently-replied-users", {
      userId: player.getId(),
      limit: 11
    })
    let rank_emoji = [
      "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ"
    ]
    var count = 0
    let user_list = []
    if (replied_users.len > 0) {
      each (let ru, replied_users) {
        if ru.user.isSuspended continue

        let data = []
        let replied_user = User(ru.user.id)
        // è‡ªèº«ã¯é™¤å¤–
        if ((!player.isYourself(replied_user.getId())) && (count < 10)) {
          data.push(`{rank_emoji[count]}: `)
          if (count == 0) {
            data.push("$[jelly ")
          }
          data.push(`?[{replied_user.getName()}]({replied_user.getProfileURL()})`)
          if (count == 0) {
            data.push("]")
          }
          user_list.push(data.join())
          count += 1
        }
      }
      // çµæœè¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let resultMfm = [
        user_list.join(Str:lf)
      ].join(Str:lf)

      // çµæœè¡¨ç¤ºUIæ›´æ–°
      Ui:get("resultMfm").update({
       text: resultMfm
      })

      // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let postText = [
        `{player.getName()}ã®{PLAY_NAME}ã¯`
        resultMfm
        TAG_NAME
        PLAY_URL
      ].join(Str:lf)

      // æŠ•ç¨¿UIæ›´æ–°
      Ui:get("postFormButton").update({
        text: "æŠ•ç¨¿ã™ã‚‹"
        form: {
          text: postText
        }
        primary: true
        rounded: true
      })

      Ui:hidden("loading_area", true)
      Ui:hidden("main_area", false)
      Ui:hidden("post_area", false)

    } else {
      // çµæœè¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let resultMfm = [
        "<center>"
        "âš ç›´è¿‘1000ä»¶ã®ãƒãƒ¼ãƒˆå†…ã«ãƒªãƒ—ãƒ©ã‚¤ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        "</center>"
      ].join(Str:lf)

      // çµæœè¡¨ç¤ºUIæ›´æ–°
      Ui:get("resultMfm").update({
        text: resultMfm
      })

      Ui:hidden("loading_area", true)
      Ui:hidden("main_area", false)
    }
  }
  main()
}

Ui:render([
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 {PLAY_NAME}]`
      }, "titleMfm")
    ]
    align: "center"
  }, "title_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 $[bounce Now Loading...]]`
      }, "loadingMfm")
    ]
    align: "center"
  } "loading_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({}, "resultMfm")
    ]
//    align: "center"
    hidden: true
  }, "main_area")
  Ui:C:container({
    children: [
      Ui:C:postFormButton({}, "postFormButton")
    ]
    align: "center"
    hidden: true
  }, "post_area")
])
if (USER_ID != null) {
  Game()
} else {
  Mk:dialog("", [
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
    "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­"
  ].join(Str:lf), "error")
}
