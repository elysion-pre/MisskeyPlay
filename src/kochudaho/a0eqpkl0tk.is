/// @ 0.19.0
// ä»Šæ—¥ã®ãŠãã‚Šã‚‚ã®
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/`
let PLAY_TAG = "#A4U_GIFT"
let PLAY_ID = if exists THIS_ID THIS_ID else PLAY_URL

let random = eval {
  let id = if exists USER_ID USER_ID else Util:uuid()
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ä»Šæ—¥ã®æ—¥ä»˜ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
//  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}`)
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+æ™‚é–“ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
//  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}-{Date:hour()}`)
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ãƒŸãƒªç§’ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}-{Date:minute()}-{Date:second()}-{Date:millisecond()}`)
}

// é™¤å¤–ã™ã‚‹çµµæ–‡å­—ã®ã‚«ãƒ†ã‚´ãƒª
// pagesã®jsonãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// https://{SERVER_URL}/@elysion/pages/ignore_emoji_data
let IGNORE_EMOJI_LIST = eval {
  var data = null
  let pages_data = Mk:api("pages/show", {
    name: "ignore_emoji_data"
    username: "elysion"
  })
  if (Core:type(pages_data) == "error") {
    data = {
      category: [
        null
      ]
    }
  } else {
    data = Json:parse(pages_data.content[0].text)
  }
  data
}

// é™¤å¤–ã™ã‚‹çµµæ–‡å­—ã®ã‚«ãƒ†ã‚´ãƒª
// pagesã®jsonãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// https://{SERVER_URL}/@elysion/pages/gift_data
let TWEMOJI_LIST = eval {
  var data = null
  let pages_data = Mk:api("pages/show", {
    name: "gift_data"
    username: "elysion"
  })
  if (Core:type(pages_data) == "error") {
    Core:abort([
      `pagesã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`
      `{SERVER_URL}/@elysion/pages/gift_data`
      `ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚`
    ].join(Str:lf))
  } else {
    data = Json:parse(pages_data.content[0].text)
  }
  data
}

@EmojiManager() {
  let this = {
    obj: {}
    categories: []
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    constructor: @() {
      // é™¤å¤–ã‚«ãƒ†ã‚´ãƒªä»¥å¤–ã®çµµæ–‡å­—æŠ½å‡º
      this.obj = CUSTOM_EMOJIS.filter(@(emoji) {
        !IGNORE_EMOJI_LIST.category.incl(emoji.category)
      })
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼æŠ½å‡º
      var prev_category = ""
      for (let i = 0, (this.obj.len - 1)) {
        if (prev_category != this.obj[i].category) {
          this.categories.push(this.obj[i].category)
        }
        prev_category = this.obj[i].category
      }
      this
    }
    // çµµæ–‡å­—ã‚’è¿”ã™
    // param: name<str>
    // return: <arr>
    getEmoji: @(name) {
      this.obj.filter(@(v) {
        (v.name == name)
      }).pop()
    }
    // ãƒ©ãƒ³ãƒ€ãƒ ãªçµµæ–‡å­—ã‚’è¿”ã™
    // return: <obj>
    getRandomEmoji: @() {
      this.obj[random(0, (this.obj.len - 1))]
    }
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã®çµµæ–‡å­—ã‚’è¿”ã™
    // param: category<str>
    // return: <arr>
    getCategoryEmojis: @(category) {
      this.obj.filter(@(emoji) {
        emoji.category == category
      })
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
    // param: emoji<obj>
    // return: <arr>
    getEmojiAliases: @(emoji) {
      var aliases = []
      // çµµæ–‡å­—è¿½åŠ ç›´å¾Œã¯aliasesã«ä½•ã‚‚å…¥ã£ã¦ã„ãªã„å ´åˆãŒã‚ã‚‹
      if (emoji["aliases"].len > 0) {
        // ""ã®å ´åˆ
        if (emoji["aliases"][0] == "") {
          // emoji.nameã‚’è¿”ã™
          aliases.push(emoji["name"])
        } else {
          // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
          aliases = emoji["aliases"]
        }
      } else {
        // emoji.nameã‚’è¿”ã™
        aliases.push(emoji["name"])
      }
      aliases
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™(fRand = trueã§ãƒ©ãƒ³ãƒ€ãƒ )
    // param: emoji<obj>
    // param: fRand<bool>
    // return: <str>
    getEmojiAliase: @(emoji, fRand) {
      var aliase = ""
      var aliases = this.getEmojiAliases(emoji)
      if (fRand) {
        // ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
        aliase = aliases[random(0, (aliases.len - 1))]
      } else {
        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å…ˆé ­ã‚’è¿”ã™
        aliase = aliases[0]
      }
      aliase
    }
  }
  this.constructor()
}

@Game() {
  var emojiMng = null

  // åˆæœŸåŒ–
  @init() {

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    emojiMng = EmojiManager()

    main()
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    // èª•ç”Ÿæ—¥ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    var fHBD = false
    // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    var fCustomEmoji = false
    // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­— or twemoji
    // ç¢ºç‡50%
    var gift = ""
    if (random(0, 100) >= 50) {
      gift = `:{emojiMng.getRandomEmoji().name}:`
      fCustomEmoji = true
    } else {
      if (random(0, 100) >= 50) {
        gift = TWEMOJI_LIST.twemoji_food_and_drink[random(0, (TWEMOJI_LIST.twemoji_food_and_drink.len - 1))]
      } else {
        gift = TWEMOJI_LIST.twemoji_object[random(0, (TWEMOJI_LIST.twemoji_object.len - 1))]
      }
    }

    let omanMfm = [
      `$[position.y=1.3 $[scale.x=0.5,y=0.5 â—]]`
      `$[position.y=1 $[scale.x=2.5,y=2.0 $[fg.color=888578 â–²]]]`
      `$[position.x=-1.5,y=0.3 $[scale.x=1.5,y=1.5 $[rotate.deg=75 ã]]]$[position $[scale.x=4.0 $[rotate.deg=90 ï¼ˆ]]]$[position.x=1.5,y=0.3 $[scale.x=1.5,y=1.5 $[rotate.deg=105 $[flip.v ã]]]]`
      `$[rotate.deg=60 $[flip âœ“]]ã€€$[position.x=-0.4,y=0.7 $[scale.x=2.0 $[rotate.deg=30 ãƒ]]]$[position.y=0.5 $[scale **â—¯**]]$[position.y=0.5 $[scale **â—¯**]]$[position.x=0.4,y=0.7 $[scale.x=2.0 $[rotate.deg=-30 $[flip ãƒ]]]]ã€€$[rotate.deg=-60 âœ“]`
      `$[position.y=-0.5 $[rotate.deg=60 $[flip âœ“]]]ã€€ã€€$[position.x=0.1,y=-1.05 $[scale.x=0.6,y=0.6 â—]]$[position.x=0.0,y=-1.05 $[scale.x=0.6,y=0.6 â—]]ã€€ã€€$[position.y=-0.5 $[rotate.deg=-60 âœ“]]`
      `$[position.y=-1.2 ã]ã€€ã€€$[position.x=0,y=-1.5 $[scale $[rotate.deg=-20 âŠ‚]]]$[position.x=-0,y=-1.5 $[scale $[rotate.deg=20 âŠƒ]]]ã€€ã€€$[position.y=-1.2 $[flip ã]]`
      `$[position.y=-3.2 $[scale.x=0.4,y=0.4 **â—¯**]]`
      `ã€€$[position.y=-3 $[rotate.deg=60 $[flip âœ“]]]ã€€ã€€ã€€ã€€ã€€ã€€$[position.y=-3 $[rotate.deg=-60 âœ“]]ã€€`
      `$[position.x=0.2,y=-3.0 $[scale.x=2.0,y=2.0 $[rotate.deg=210 âœ‹]]]ã€€$[position.x=-0.2,y=-3.0 $[scale.x=2.0,y=2.0 $[rotate.deg=150 $[flip âœ‹]]]]`
      `$[position.y=-5.5 $[scale.x=5.0,y=5.0 $[blur $[blur $[fg.color=cc8855 â—]]]]]`
    ].join(Str:lf)

    let titleMfm = eval {
      var mfm = "ğ‘·ğ’“ğ’†ğ’”ğ’†ğ’ğ’• ğ’‡ğ’ğ’“ ğ’šğ’ğ’–"
      let user = Mk:api("users/show", {
        userId: USER_ID
      })
      if Core:type(user) != "error" {
        if user.birthday != null {
          if (Date:month() == Date:month(Date:parse(user.birthday)) && Date:day() == Date:day(Date:parse(user.birthday))) {
            mfm = "ğ‘¯ğ’‚ğ’‘ğ’‘ğ’š ğ‘©ğ’Šğ’“ğ’•ğ’‰ğ’…ğ’‚ğ’š"
            fHBD = true
          }
        }
      }
      mfm
    }
    
    let giftMfm = eval {
      var mfm = ""
      if fHBD {
        mfm = `$[position.y=-6.5 $[scale.x=2.0,y=2.0 ğŸ‚]]`
      } else {
        if !fCustomEmoji {
          mfm = `$[position.y=-6.5 $[scale.x=2.0,y=2.0 {gift}]]`
        } else {
          mfm = `$[position.y=-6.5 $[scale.x=1.25,y=1.25 {gift}]]`
        }
      }
      mfm
    }
    
    let messageMfm = eval {
      var mfm = ""
      if fHBD {
        mfm = `{if USER_NAME != null USER_NAME else USER_USERNAME}ã•ã‚“ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ğŸğŸ‚ğŸ‰`
      } else {
        mfm = `ä»Šæ—¥ã¯{gift}ã‚’ã‚‚ã‚‰ã£ãŸã‚ˆï¼`
      }
      mfm
    }

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `$[x2 {titleMfm}]`
      omanMfm
      giftMfm
      messageMfm
    ].join(Str:lf)

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `<center>`
              resultMfm
              `</center>`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: [
                `<center>`
                resultMfm
                PLAY_URL
                PLAY_TAG
                `</center>`
              ].join(Str:lf)
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    ])
  }
  // æç”»
  // param: components<arr>
  @render(components) {
    Ui:render(components)
  }
  init()
}

Game()
