/// @ 0.19.0
// ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

// description:
// ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«é–¢ã—ã¦
// ä¸‹è¨˜å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§
// https://misskey-hub.net/ja/docs/for-developers/api/token/

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/9z9ow5wnyo`
let PLAY_TAG = "#ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°"

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
// param: id<str>
@User(id, token) {
  let this = {
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    // param: id<str>
    constructor: @(id, token) {
      this.user = Mk:api("users/show", {
        userId: id
      }, token)
      this
    }
    // åå‰å–å¾—
    // nameãŒæœªå…¥åŠ›ãªã‚‰usernameã‚’è¿”ã™
    // return: <str>
    getName: @() { if this.user.name == null return this.user.username else return this.user.name }
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³åå–å¾—(@username@host)
    // return: <str>
    getMentionName: @() {
      match this.user.host {
        null => { return `@{this.user.username}` }
        * => { return `@{this.user.username}@{this.user.host}` }
      }
    }
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLå–å¾—
    // return: <str>
    getProfileURL: @() {
      match this.host {
        null => { return `{SERVER_URL}/@{this.user.username}` }
        * => { return `https://{this.user.host}/@{this.user.username}` }
      }
    }
    // ãƒãƒ¼ãƒˆæ•°å–å¾—
    // return: <num>
    getNotesCount: @() { this.user.notesCount }
    // ãƒãƒ¼ãƒˆå–å¾—
    // param: limit<num>
    // return: <arr>
    getNotes: @(limit) {
      let func = @(limit, params) {
        if (params.limit <= 0) {
          return []
        }
        let notes = Mk:api("users/notes", params)
        if (notes.len < params.limit) {
          return notes
        }
        limit -= params.limit
        return notes.concat(func(limit, {
          userId: this.user.id,
          withChannelNotes: params.withChannelNotes,
          limit: Math:min(limit, 100),
          untilId: notes[notes.len - 1].id
        }))
      }
      return func(limit, {
        userId: this.user.id,
        withChannelNotes: true,
        limit: Math:min(limit, 100)
      })
    }
    // ä»Šæ—¥ã®ãƒãƒ¼ãƒˆå–å¾—
    // param: limit<num>
    // return: <arr>
    getTodayNotes: @() {
      var notes = Mk:api("users/notes", {
        userId: this.user.id,
        withChannelNotes: true,
        limit: 100
      }).filter(@(i) {
        Date:year(Date:parse(i.createdAt)) == Date:year(Date:now()) && Date:month(Date:parse(i.createdAt)) == Date:month(Date:now()) && Date:day(Date:parse(i.createdAt)) == Date:day(Date:now())
      })
      if (notes.len < 100) return notes

      loop {
        let add_notes = Mk:api("users/notes", {
          userId: this.user.id,
          withChannelNotes: true,
          limit: 100,
          untilId: notes[notes.len - 1].id
        }).filter(@(i) {
          Date:year(Date:parse(i.createdAt)) == Date:year(Date:now()) && Date:month(Date:parse(i.createdAt)) == Date:month(Date:now()) && Date:day(Date:parse(i.createdAt)) == Date:day(Date:now())
        })
        notes = notes.concat(add_notes)
        if add_notes.len < 100 break
      }
      notes
    }
    // idãŒè‡ªåˆ†ã‹ã©ã†ã‹
    // param: id<str>
    // return: <bool>
    isYourself: @(id) { if this.user.id == id return true else return false }
  }
  this.constructor(id, token)
}

@Game() {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
  var user = null
  // ãƒˆãƒ¼ã‚¯ãƒ³
  var token = null

  // åˆæœŸåŒ–
  @init() {
    if (USER_ID == null) {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      token_check()
    }
  }
  // ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª
  @token_check() {
    token = Mk:load(`@{USER_ID}/token`)
//<:`token: {token}`
    if (token != null && token != "") {
      render([
        Ui:C:container({
          children: [
            Ui:C:button({
              text: `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
              onClick: @() {
                Mk:save(`@{USER_ID}/token`, null)
                Mk:dialog("å®Œäº†", [
                  `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`
                  `$[x2 :orenitehakaizumi::mimi_hate:]`
                ].join(Str:lf), "success")
                token_check()
              }
            })
            Ui:C:button({
              text: `å®Ÿè¡Œã™ã‚‹`
              onClick: @() {
                user = User(USER_ID, token)
//<:`user: {user}`
                if Core:type(user.user) == "error" {
                  match Obj:get(user.user.info, "code") {
                    "FAILED_TO_RESOLVE_REMOTE_USER" =>{
                      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
                        `ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£æ±ºã«å¤±æ•—ã—ã¾ã—ãŸ`
                        `$[x2 :sonnannaiyo::mimi_hate:]`
                      ].join(Str:lf), "error")
                    }
                    "CREDENTIAL_REQUIRED" =>{
                      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
                        `è³‡æ ¼æƒ…å ±ãŒå¿…è¦ã§ã™`
                        `$[x2 :sonnannaiyo::mimi_hate:]`
                      ].join(Str:lf), "error")
                    }
                    "AUTHENTICATION_FAILED" =>{
                      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
                        `èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`
                        `$[x2 :chotochau::mimi_hate:]`
                        `ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„`
                      ].join(Str:lf), "error")
                    }
                    * =>{
                      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
                        `äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`
                        `$[x2 :dekimasen::mimi_hate:]`
                      ].join(Str:lf), "error")
                    }
                  }
                  token_check()
                } else {
                  exec()
                }
              }
              primary: true
            })
          ]
          align: "center"
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
                    `ã€€æœ¬Playã®ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `3.å‰Šé™¤`
                    `ã€€ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€ğŸ—‘ï¸(ã‚´ãƒŸç®±)ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€å‰Šé™¤å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤æ‰‹é †"
              opened: true
            })
          ]
          bgColor: "#ba8b55" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "dashed" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
      ])
    } else {
      render([
        Ui:C:container({
          children: [
            Ui:C:textInput({
              onInput: @(text) {
                token = text
              }
              default: ""
              label: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            })
            Ui:C:button({
              text: `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜`
              onClick: @() {
                if (token != null && token != "") {
                  Mk:save(`@{USER_ID}/token`, token)
                  Mk:dialog("å®Œäº†", [
                    `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ`
                    `$[x2 :orenitekaishuzumi::mimi_heart:]`
                    `<small>âš ï¸ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä»–äººã«çŸ¥ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„</small>`
                  ].join(Str:lf), "success")
                  token_check()
                }
              }
            })
          ]
          align: "center"
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.åå‰`
                    `ã€€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®åå‰ã‚’å…¥åŠ›`
                    `3.æ¨©é™`
                    `ã€€ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æƒ…å ±ã‚’è¦‹ã‚‹ã€‘ã‚’æœ‰åŠ¹ã«`
                    `4.ç™ºè¡Œ`
                    `ã€€å³ä¸Šã®ã€âœ”ï¸ã€‘ã‚’æŠ¼ä¸‹ã—ç™ºè¡Œ`
                    `ã€€ç¢ºèªã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã‚³ãƒ”ãƒ¼`
                    `5.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜`
                    `ã€€æœ¬Playã«ãƒšãƒ¼ã‚¹ãƒˆã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€ä¿å­˜å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆãƒ»ä¿å­˜æ‰‹é †"
              opened: true
            })
          ]
          bgColor: "#89e555" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "solid" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
                    `ã€€æœ¬Playã®ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `3.å‰Šé™¤`
                    `ã€€ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€ğŸ—‘ï¸(ã‚´ãƒŸç®±)ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€å‰Šé™¤å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤æ‰‹é †"
              opened: false
            })
          ]
          bgColor: "#ba8b55" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "dashed" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
      ])
    }
  }
  // å®Ÿè¡Œ
  @exec() {

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    let loggedInDays = user.user.loggedInDays
//<:`loggedInDays: {loggedInDays}`
    if (loggedInDays != null) {
      // çµæœè¡¨ç¤ºç”¨
      let resultMfm = [
        `{user.getName()}ã®ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°ã¯`
        `***$[fg.color=f00 {loggedInDays}]***`
      ].join(Str:lf)

      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                resultMfm
              ].join(Str:lf)
            })
            Ui:C:button({
              text: `æˆ»ã‚‹`
              onClick: init
            })
            Ui:C:postFormButton({
              text: "æŠ•ç¨¿ã™ã‚‹"
              form: {
                text: [
                  `<center>`
                  resultMfm
                  PLAY_URL
                  PLAY_TAG
                  `</center>`
                ].join(Str:lf)
              }
              primary: true
              rounded: true
            })
          ]
          align: "center"
        })
      ])
    } else {
      
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
            Ui:C:button({
              text: `æˆ»ã‚‹`
              onClick: init
            })
          ]
          align: "center"
        })
      ])

      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ­£ã—ãå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ä¸€åº¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¦ã€æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦è©¦ã—ã¦ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    }
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
