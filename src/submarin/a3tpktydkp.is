/// @ 0.19.0
// ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

// description: 
// ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€ã™ã¹ã¦ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¯¾è±¡ã€ã‚’é¸æŠã—ãŸå ´åˆã€ã‹ãªã‚Šæ™‚é–“ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
// 8ä¸‡ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä»¥ä¸Šã¯æœªæ¤œè¨¼ã€‚è‡ªå·±è²¬ä»»ã§ã€‚

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/a3tpktydkp`
let PLAY_TAG = "#ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³"

@Game() {
  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ
  var reaction_list = null
  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¤œç´¢ãƒ•ãƒ©ã‚°
  var fSearchAll = false
  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
  // 0: ä¸¡æ–¹
  // 1: ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿
  // 2: çµµæ–‡å­—ã®ã¿
  var reaction_disp_mode = 0

  // åˆæœŸåŒ–
  @init() {
    if USER_ID == null {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :destroying_hisubway:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :kaikigenshou::bakuhatsu_sakananoonigiri:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                `é›†è¨ˆã™ã‚‹ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„`
              ].join(Str:lf)
            })
            Ui:C:buttons({
              buttons: [
                {
                  text: "ä»Šæ—¥ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
                  onClick: @() {
                    fSearchAll = false
                    exec()
                  }
                  primary: true
                }
                {
                  text: "ä»Šã¾ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
                  onClick: @() {
                    fSearchAll = true
                    exec()
                  }
//                  primary: true
                }
              ]
            })
            Ui:C:mfm({
              text: [
                `<small>âš ï¸ã€ä»Šã¾ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’é¸æŠã—ãŸå ´åˆã€ã‹ãªã‚Šæ™‚é–“ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚</small>`
              ].join(Str:lf)
            })
          ]
          align: "center"
        })
      ])
    }
  }
  
  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆè¨ˆå€¤ã‚’è¨ˆç®—
  // param: reaction_data<arr>
  // return: <obj>
  @calcTotalReactions(reaction_data) {
    // åˆè¨ˆå€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
    let result = reaction_data.reduce(@(a, obj, i) {
      Obj:kvs(obj).reduce(@(a2, entry, i2) {
        let key = entry[0]
        let value = entry[1]
        if Obj:has(a2, key) {
          // ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å€¤ã‚’æ›´æ–°
          Obj:set(a2, key, Obj:get(a2, key) + value)
        } else {
          // ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ã—ã„ã‚­ãƒ¼ã¨å€¤ã‚’è¿½åŠ 
          Obj:set(a2, key, value)
        }
        return a2
      }, a)
      return a
    }, {})

    // çµæœã‚’ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã®ãƒªã‚¹ãƒˆã«å¤‰æ›ã—ã€å€¤ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
    let entries = Obj:kvs(result).sort(@(a, b) {
      (b[1] - a[1])
    })

    // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®ã‚¨ãƒ³ãƒˆãƒªã‚’æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™
    let s_result = {}
    each (let entry, entries) {
      Obj:set(s_result, entry[0], entry[1])
    }

    return s_result
  }
  // å®Ÿè¡Œ
  @exec() {
    let info_text = if fSearchAll `ä»Šã¾ã§` else `ä»Šæ—¥`
    
    let render_components = []

    render_components.push(
      Ui:C:mfm({
        text: [
          `$[x2 Now Loading]`
          `{info_text}ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
        ].join(Str:lf)
      })
    )
    
    if fSearchAll {
      render_components.push(
        Ui:C:mfm({}, "reaction_data")
      )
    }

    render([
      Ui:C:container({
        children: render_components
        align: "center"
      })
    ])

    let since_date = if !fSearchAll Date:parse(`{Date:year()}-{Date:month().to_str().pad_start(2, "0")}-{Date:day().to_str().pad_start(2, "0")}T00:00:00.000+09:00`) else 1

// users/reactions
    var users_reactions = Mk:api("users/reactions", {
      userId: USER_ID,
      limit: 100,
      sinceDate: since_date
    })
    if fSearchAll {
      // ä½œæ¥­ä¸­UIæ›´æ–°
      Ui:get("reaction_data").update({
        text: `<small>{users_reactions.len}</small>`
      })
    }

    if Core:type(users_reactions) == "error" {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                `$[x4 :destroying_hisubway:]`
                `?[è¨­å®š -> ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼]({SERVER_URL}/settings/privacy)`
              ].join(Str:lf)
            })
          ]
          align: "center"
        })
      ])
      
      Mk:dialog(users_reactions.info.code, [
        users_reactions.info.message
        `$[x2 :kaikigenshou::bakuhatsu_sakananoonigiri:]`
        `?[è¨­å®š -> ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼]({SERVER_URL}/settings/privacy)ã‹ã‚‰`
        `ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å…¬é–‹ã™ã‚‹ã€‘ã‚’ONã«ã—ã¦ãã ã•ã„`
      ].join(Str:lf), "error")
      
      return 0
    }

    if users_reactions.len == 0 {

      // çµæœè¡¨ç¤ºç”¨
      let resultMfm = [
        `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`
      ].join(Str:lf)
      
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                resultMfm
              ].join(Str:lf)
            })
          ]
          align: "center"
        })
      ])

      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :nai::kanashii_sakananoonigiri:]`
        `ãŸãã•ã‚“ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã‚ˆã†ã­ï¼`
      ].join(Str:lf), "error")
      
      return 0
    }

    if users_reactions.len == 100 {
      loop {
        let works = Mk:api("users/reactions", {
          userId: USER_ID,
          limit: 100,
          sinceId: users_reactions[users_reactions.len - 1].id
        })
        if works.len == 0 break

        users_reactions = users_reactions.concat(works)
        if fSearchAll {
          // ä½œæ¥­ä¸­UIæ›´æ–°
          Ui:get("reaction_data").update({
            text: `<small>{users_reactions.len}</small>`
          })
        }
        if works.len < 100 break
      }
    }
    
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±èµ°æŸ»ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])
//<:`users_reactions[0]: {users_reactions[0]}`
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãƒãƒ¼ãƒˆã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    let reactions = users_reactions.map(@(v) {
      let obj = {}
      Obj:set(obj, v.type, 1)
      obj
    })

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆè¨ˆå€¤ã‚’è¨ˆç®—ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
              `<small>{reactions.len}ä»¶ã‚’å¯¾è±¡ã«é›†è¨ˆã‚’è¡Œã£ã¦ã„ã¾ã™</small>`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])
      
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ•°ã‚’åˆè¨ˆã™ã‚‹
    reaction_list = calcTotalReactions(reactions)
//<:`reaction_list: {reaction_list}`

    main()
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
  
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `çµæœæç”»ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    let results = eval {
      match reaction_disp_mode {
        // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿ã«ã™ã‚‹
        1 => {
          Obj:kvs(reaction_list).filter(@(i) {
            i[0].index_of("@.:") != -1 && i[0].index_of("@") != -1
          }).map(@(v) {
            [ v[0].replace("@.:", ":"), v[1] ]
          })
        }
        // çµµæ–‡å­—ã®ã¿ã«ã™ã‚‹
        2 => {
          Obj:kvs(reaction_list).filter(@(i) {
            i[0].index_of(":") == -1
          })
        }
        * => {
          Obj:kvs(reaction_list).filter(@(i) {
            i[0].index_of(":") == -1 || (i[0].index_of("@.:") != -1 && i[0].index_of("@") != -1)
          }).map(@(v) {
            [ v[0].replace("@.:", ":"), v[1] ]
          })
        }
      }
    }
//<:`results: {results}`

    let data_all = results.map(@(v) {
      `{v[0]}: {v[1]}`
    })
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã™ã¹ã¦ã®æ•°å€¤ã®åˆè¨ˆå€¤
    let data_all_count = results.reduce(@(a, v, i) {
      if Core:type(v[1]) == "num" return a + v[1]
      return a
    }, 0)

// 10
    let data10 = results.slice(0, 10).map(@(v) {
      `{v[0]}: {v[1]}`
    })
    let data10_count = results.reduce(@(a, v, i) {
      if Core:type(v[1]) == "num" && i < 10 return a + v[1]
      return a
    }, 0)

// 50
    let data50 = results.slice(0, 50).map(@(v) {
      `{v[0]}: {v[1]}`
    })
    let data50_count = results.reduce(@(a, v, i) {
      if Core:type(v[1]) == "num" && i < 50 return a + v[1]
      return a
    }, 0)

// 100
    let data100 = results.slice(0, 100).map(@(v) {
      `{v[0]}: {v[1]}`
    })
    let data100_count = results.reduce(@(a, v, i) {
      if Core:type(v[1]) == "num" && i < 100 return a + v[1]
      return a
    }, 0)

    let info_text = if fSearchAll `ä»Šã¾ã§` else `ä»Šæ—¥`

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`
      `ç·æ•°: {data_all_count}`
      `ç¨®é¡: {data_all.len}`
      data_all.join(", ")
    ].join(Str:lf)

    // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    let postText = [
      `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`
      `ç·æ•°: {data_all_count}`
      `ç¨®é¡: {data_all.len}`
      data_all.join(", ")
    ]
    if reaction_disp_mode == 1 postText.push(`<small>ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿</small>`)
    if reaction_disp_mode == 2 postText.push(`<small>çµµæ–‡å­—ã®ã¿</small>`)

// 10
    let postText10 = [
      `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`
      `ç·æ•°: {data_all_count}`
      `ç¨®é¡: {data10.len}`
      data10.join(", ")
    ]
    if data_all.len > 10 postText10.push(`<small>âš ï¸ä¸Šä½10ç¨®ã¾ã§è¡¨ç¤º</small>`)
    if reaction_disp_mode == 1 postText10.push(`<small>ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿</small>`)
    if reaction_disp_mode == 2 postText10.push(`<small>çµµæ–‡å­—ã®ã¿</small>`)

// 50
    let postText50 = [
      `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`
      `ç·æ•°: {data_all_count}`
      `ç¨®é¡: {data50.len}`
      data50.join(", ")
    ]
    if data_all.len > 50 postText50.push(`<small>âš ï¸ä¸Šä½50ç¨®ã¾ã§è¡¨ç¤º</small>`)
    if reaction_disp_mode == 1 postText50.push(`<small>ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿</small>`)
    if reaction_disp_mode == 2 postText50.push(`<small>çµµæ–‡å­—ã®ã¿</small>`)

// 100
    let postText100 = [
      `{info_text}ãŠãã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`
      `ç·æ•°: {data_all_count}`
      `ç¨®é¡: {data_all.len}`
      data100.join(", ")
    ]
    if data_all.len > 100 postText100.push(`<small>âš ï¸ä¸Šä½100ç¨®ã¾ã§è¡¨ç¤º</small>`)
    if reaction_disp_mode == 1 postText100.push(`<small>ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿</small>`)
    if reaction_disp_mode == 2 postText100.push(`<small>çµµæ–‡å­—ã®ã¿</small>`)

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              resultMfm
            ].join(Str:lf)
          })
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: [
                `<center>`
                postText.join(Str:lf)
                PLAY_URL
                PLAY_TAG
                `</center>`
              ].join(Str:lf)
            }
            primary: true
            rounded: true
          })
          Ui:C:mfm({
            text: "<small>âš ï¸æ–‡å­—æ•°ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã‚‹å ´åˆã¯ä¸‹éƒ¨ã«ã‚ã‚‹æŠ•ç¨¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„</small>"
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:postFormButton({
                    text: "æŠ•ç¨¿ã™ã‚‹(ä¸Šä½10ç¨®ã¾ã§)"
                    form: {
                      text: [
                        `<center>`
                        postText10.join(Str:lf)
                        PLAY_URL
                        PLAY_TAG
                        `</center>`
                      ].join(Str:lf)
                    }
                    primary: true
                    rounded: true
                  })
                  Ui:C:postFormButton({
                    text: "æŠ•ç¨¿ã™ã‚‹(ä¸Šä½50ç¨®ã¾ã§)"
                    form: {
                      text: [
                        `<center>`
                        postText50.join(Str:lf)
                        PLAY_URL
                        PLAY_TAG
                        `</center>`
                      ].join(Str:lf)
                    }
                    primary: true
                    rounded: true
                  })
                  Ui:C:postFormButton({
                    text: "æŠ•ç¨¿ã™ã‚‹(ä¸Šä½100ç¨®ã¾ã§)"
                    form: {
                      text: [
                        `<center>`
                        postText100.join(Str:lf)
                        PLAY_URL
                        PLAY_TAG
                        `</center>`
                      ].join(Str:lf)
                    }
                    primary: true
                    rounded: true
                  })
                ]
              })
            ]
            title: "æŠ•ç¨¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³"
            opened: true
          })
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:button({
                    onClick: @() {
                      reaction_disp_mode = 1
                      main()
                    }
                    text: "ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ã¿ã‚’è¡¨ç¤º"
                  })
                  Ui:C:button({
                    onClick: @() {
                      reaction_disp_mode = 2
                      main()
                    }
                    text: "çµµæ–‡å­—ã®ã¿ã‚’è¡¨ç¤º"
                  })
                  Ui:C:button({
                    onClick: @() {
                      reaction_disp_mode = 0
                      main()
                    }
                    text: "ä¸¡æ–¹ã‚’è¡¨ç¤º"
                  })
                ]
                padding: 5
              })
            ]
            title: "ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºè¨­å®š"
            opened: true
          })
        ]
        align: "center"
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
