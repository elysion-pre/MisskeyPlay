/// @ 0.19.0
// ã‚¿ã‚°æŠ•ç¨¿æ•°
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

// ã‚¿ã‚°æ¤œç´¢
// param: search_tag<str>
// param: fWithFiles<bool>
// return: <arr>
@getSearchByTag(search_tag, fWithFiles) {
  var notes = Mk:api("notes/search-by-tag", {
    withFiles: fWithFiles,
    limit: 100,
    tag: search_tag
  })
  if (notes.len < 100) return notes

  loop {
    let add_notes = Mk:api("notes/search-by-tag", {
      withFiles: fWithFiles,
      limit: 100,
      tag: search_tag,
      untilId: notes[notes.len - 1].id
    })
    notes = notes.concat(add_notes)
    if add_notes.len < 100 break
  }
  notes
}

@Game() {
  var search_data = {}

  // åˆæœŸåŒ–
  @init() {
//    search_data = Mk:save(`@{USER_ID}/search_data`, null)

    search_data = Mk:load(`@{USER_ID}/search_data`)
    if search_data == null {
      search_data = {
        tags: ""
        fWithFiles: false
      }
    }
    
    render([
      Ui:C:container({
        children: [
          Ui:C:textInput({
            onInput: @(text) {
              search_data.tags = text
            }
            default: search_data.tags
            label: "ã‚¿ã‚°"
            caption: "#ã®æœ‰ç„¡ã¯å•ã‚ãšã€‚,(ã‚«ãƒ³ãƒ)åŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯èƒ½"
          })
          Ui:C:switch({
            onChange: @(enabled) {
              search_data.fWithFiles = enabled
            }
            default: search_data.fWithFiles
            label: "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿"
            caption: "âš ï¸OFFã«ã™ã‚‹ã¨æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ãƒãƒ¼ãƒˆã‚‚æ¤œç´¢å¯¾è±¡ã«ãªã‚Šã¾ã™"
          })
          Ui:C:button({
            onClick: @() {
              Mk:save(`@{USER_ID}/search_data`, search_data)
              main()
            }
            text: "æ¤œç´¢"
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    ])
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    let result_data = []
    let tags = search_data.tags.split(",").map(@(v) {
      v.replace("#", "").replace(" ", "").replace("ã€€", "")
    })

    each (let tag, tags) {
      if tag.len == 0 continue
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                `$[x2 Now Loading]`
                `ã€{tag}ã€‘ã‚¿ã‚°æ¤œç´¢ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
              ].join(Str:lf)
            })
          ]
          align: "center"
        })
      ])
      result_data.push({
        tag: tag,
        notes: getSearchByTag(tag, search_data.fWithFiles)
      })
    }

    // çµæœè¡¨ç¤ºç”¨
    let result_componets = []

    each (let data, result_data) {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: [
                `$[x2 Now Loading]`
                `çµæœæç”»ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
                `<small>{data.notes.len}ä»¶ã®ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</small>`
              ].join(Str:lf)
            })
          ]
          align: "center"
        })
      ])
      result_componets.push(
        Ui:C:folder({
          children: [
            Ui:C:mfm({
              text: [
                `#{data.tag}`
                `æŠ•ç¨¿æ•°ã€€: {data.notes.len}ä»¶`
              ].join(Str:lf)
            })
          ]
          title: `çµæœ: #{data.tag}`
        })
      )
    }

    render([
      Ui:C:container({
        children: result_componets
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:button({
            text: "ã‚‚ã†ä¸€åº¦"
            onClick: init
          })
          Ui:C:mfm({
            text: [
              `<small>âš ï¸ã‚¿ã‚°ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã“ã®ç”»é¢ã‚’é›¢ã‚Œã¦æˆ»ã£ã¦ããŸå ´åˆ`
              `ã€ã‚‚ã†ä¸€åº¦ã€‘ãƒœã‚¿ãƒ³ãŒåŠ¹ã‹ãªããªã‚‹ã®ã§ä¸‹è¨˜ã®ğŸ”„(æ›´æ–°)ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</small>`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
