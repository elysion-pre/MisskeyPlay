/// @ 0.19.0
// ããŸã–ã‚ã‚·ãƒ£ãƒ„
// å‚è€ƒ: Preset -> Shuffle
// Copyright (c) 2024 @elysion
// License: MIT License
// https://github.com/elysion-pre/MisskeyPlay/blob/main/LICENSE

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/9jwc5kdl75`
let PLAY_ID = if exists THIS_ID THIS_ID else PLAY_URL

let random = eval {
  let id = if exists USER_ID USER_ID else Util:uuid()
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ä»Šæ—¥ã®æ—¥ä»˜ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
//  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}`)
  // ã‚·ãƒ¼ãƒ‰ãŒã€ŒPLAY ID+ãƒ¦ãƒ¼ã‚¶ãƒ¼ID+ãƒŸãƒªç§’ã€ã§ã‚ã‚‹ä¹±æ•°ç”Ÿæˆå™¨ã‚’ç”¨æ„
  Math:gen_rng(`{PLAY_ID}-{id}-{Date:year()}-{Date:month()}-{Date:day()}-{Date:minute()}-{Date:second()}-{Date:millisecond()}`)
}

// é™¤å¤–ã™ã‚‹çµµæ–‡å­—ã®ã‚«ãƒ†ã‚´ãƒª
// pagesã®jsonãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// https://{SERVER_URL}/@elysion/pages/ignore_emoji_data
let IGNORE_EMOJI_LIST = eval {
  var data = null
  let pages_data = Mk:api("pages/show", {
    name: "ignore_emoji_data"
    username: "elysion"
  })
  if (Core:type(pages_data) == "error") {
    data = { category: [ null ] }
  } else {
    data = Json:parse(pages_data.content[0].text)
  }
  data
}

@EmojiManager() {
  let this = {
    obj: {}
    categories: []
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    constructor: @() {
      // é™¤å¤–ã‚«ãƒ†ã‚´ãƒªä»¥å¤–ã®çµµæ–‡å­—æŠ½å‡º
      this.obj = CUSTOM_EMOJIS.filter(@(emoji) {
        !IGNORE_EMOJI_LIST.category.incl(emoji.category)
      })
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼æŠ½å‡º
      var prev_category = ""
      for (let i = 0, (this.obj.len - 1)) {
        if (prev_category != this.obj[i].category) {
          this.categories.push(this.obj[i].category)
        }
        prev_category = this.obj[i].category
      }
      this
    }
    // çµµæ–‡å­—ã‚«ãƒ†ã‚´ãƒªã‚’è¿”ã™
    // return: <arr>
    getCategories: @() {
      this.categories
    }
    // çµµæ–‡å­—ã‚’è¿”ã™
    // param: name<str>
    // return: <arr>
    getEmoji: @(name) {
      this.obj.filter(@(v) {
        (v.name == name)
      }).pop()
    }
    // ãƒ©ãƒ³ãƒ€ãƒ ãªçµµæ–‡å­—ã‚’è¿”ã™
    // return: <obj>
    getRandomEmoji: @() {
      this.obj[random(0, (this.obj.len - 1))]
    }
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã®çµµæ–‡å­—ã‚’è¿”ã™
    // param: category<str>
    // return: <arr>
    getCategoryEmojis: @(category) {
      this.obj.filter(@(emoji) {
        emoji.category == category
      })
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
    // param: emoji<obj>
    // return: <arr>
    getEmojiAliases: @(emoji) {
      var aliases = []
      // çµµæ–‡å­—è¿½åŠ ç›´å¾Œã¯aliasesã«ä½•ã‚‚å…¥ã£ã¦ã„ãªã„å ´åˆãŒã‚ã‚‹
      if (emoji["aliases"].len > 0) {
        // ""ã®å ´åˆ
        if (emoji["aliases"][0] == "") {
          // emoji.nameã‚’è¿”ã™
          aliases.push(emoji["name"])
        } else {
          // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
          aliases = emoji["aliases"]
        }
      } else {
        // emoji.nameã‚’è¿”ã™
        aliases.push(emoji["name"])
      }
      aliases
    }
    // çµµæ–‡å­—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™(fRand = trueã§ãƒ©ãƒ³ãƒ€ãƒ )
    // param: emoji<obj>
    // param: fRand<bool>
    // return: <str>
    getEmojiAliase: @(emoji, fRand) {
      var aliase = ""
      var aliases = this.getEmojiAliases(emoji)
      if (fRand) {
        // ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿”ã™
        aliase = aliases[random(0, (aliases.len - 1))]
      } else {
        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å…ˆé ­ã‚’è¿”ã™
        aliase = aliases[0]
      }
      aliase
    }
  }
  this.constructor()
}

@Game() {
  var emojiMng = null
  var results = []
  var cursor = 0

  // åˆæœŸåŒ–
  @init() {
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    emojiMng = EmojiManager()

    do()
  }
  // å®Ÿè¡Œ
  @do() {
    if (cursor != 0) {
	  	results = results.slice(0, (cursor + 1))
		  cursor = 0
	  }
	  let resultMfm = [
      `:tp:`
      `$[position.y=1 $[scale.x=5,y=5 ğŸ‘•]`
      `$[scale.x=1.75,y=1.75 $[position.y=-0.75 :{emojiMng.getRandomEmoji().name}:]]]`
      `:tp:`
    ].join(Str:lf)
    results.push(resultMfm)

  	render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: resultMfm
          })
          Ui:C:buttons({
            buttons: [
              {
                text: "â†"
                onClick: back
					    	disabled: !(results.len > 1 && (results.len - cursor) > 1)
              }, {
                text: "â†’"
                onClick: forward
					    	disabled: !(results.len > 1 && cursor > 0)
              }, {
                text: "å¼•ãç›´ã™"
                onClick: do
              }
            ]
          })
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: [
                `<center>`
                resultMfm
                PLAY_URL
                `</center>`
              ].join(Str:lf)
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    ])
  }
  // æˆ»ã‚‹
  @back() {
  	cursor = cursor + 1
  	let resultMfm = results[results.len - (cursor + 1)]
  	render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: resultMfm
          })
          Ui:C:buttons({
            buttons: [
              {
                text: "â†"
                onClick: back
					    	disabled: !(results.len > 1 && (results.len - cursor) > 1)
              }, {
                text: "â†’"
                onClick: forward
					    	disabled: !(results.len > 1 && cursor > 0)
              }, {
                text: "å¼•ãç›´ã™"
                onClick: do
              }
            ]
          })
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: [
                `<center>`
                resultMfm
                PLAY_URL
                `</center>`
              ].join(Str:lf)
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    ])
  }
  // é€²ã‚€
  @forward() {
  	cursor = cursor - 1
  	let resultMfm = results[results.len - (cursor + 1)]
  	render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: resultMfm
          })
          Ui:C:buttons({
            buttons: [
              {
                text: "â†"
                onClick: back
					    	disabled: !(results.len > 1 && (results.len - cursor) > 1)
              }, {
                text: "â†’"
                onClick: forward
					    	disabled: !(results.len > 1 && cursor > 0)
              }, {
                text: "å¼•ãç›´ã™"
                onClick: do
              }
            ]
          })
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: [
                `<center>`
                resultMfm
                PLAY_URL
                `</center>`
              ].join(Str:lf)
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    ])
  }
  // æç”»
  // param: components<arr>
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
