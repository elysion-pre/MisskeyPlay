/// @ 0.19.0
// åˆã‚ã¦ã®ãƒãƒ¼ãƒˆ
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

@Game() {
  var input_text = ""

  // åˆæœŸåŒ–
  @init() {
    if (USER_ID == null) {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      input_text = USER_ID
      render([
        Ui:C:container({
          children: [
            Ui:C:textInput({
              onInput: @(text) {
                input_text = text
              }
              default: input_text
              label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
              caption: "âš ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèªæ–¹æ³•: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«â†’rawã‚¿ãƒ–"
            })
            Ui:C:button({
              onClick: main
              text: "ç¢ºèªã™ã‚‹"
            })
          ]
          align: "center"
        })
      ])
    }
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = []
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—
    let user = Mk:api("users/show", {
      userId: input_text
    })

    match Core:type(user) {
      "error" => {
        resultMfm.push(`$[x4 :GoBack:]`)
        Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
          `å…¥åŠ›ã—ãŸIDã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
          `$[x2 :sorehanai::mimi_hate:]`
          `æœ‰åŠ¹ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IDã‚’å…¥åŠ›ã—ã¦ã­ãƒ¼ğŸ‘‹`
        ].join(Str:lf), "error")
      }
      "obj" => {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ¼ãƒˆã‚’å–å¾—
        let notes = Mk:api("users/notes", {
          userId: user.id
          sinceDate: Date:parse(user.createdAt)
          limit: 1
        })

        match Core:type(notes) {
          "error" => {
            resultMfm.push(`$[x4 :GoBack:]`)
            Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
              `ãƒãƒ¼ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`
              `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
              `æœ‰åŠ¹ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IDã‚’å…¥åŠ›ã—ã¦ã­ãƒ¼ğŸ‘‹`
            ].join(Str:lf), "error")
          }
          "arr" => {
            if (notes.len > 0) {
              let user_username = eval {
                match user.host {
                  null => { `@{user.username}` }
                  * => { `@{user.username}@{user.host}` }
                }
              }
              resultMfm.push([
                `$[tada.speed=0s ãƒãƒ¼ãƒˆå†…å®¹]`
                `>{notes[0].text}`
                `$[unixtime {Date:parse(notes[0].createdAt) / 1000}]`
                ``
                `$[tada.speed=0s ãƒãƒ¼ãƒˆã¸ã®ãƒªãƒ³ã‚¯]`
                `{SERVER_URL}/notes/{notes[0].id}`
                ``
                `<small>âš ï¸ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ã†ã¾ãå–å¾—ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small>`
              ].join(Str:lf))
            } else {
              resultMfm.push(`$[x4 :GoBack:]`)
              Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
                `ãƒãƒ¼ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`
                `$[x2 :sonnannaiyo::mimi_hate:]`
                `ãŸãã•ã‚“ãƒãƒ¼ãƒˆã—ã¦ã­ãƒ¼ğŸ‘‹`
              ].join(Str:lf), "error")
            }
          }
        }
      }
    }
    
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: resultMfm.join(Str:lf)
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:button({
            text: "ã‚‚ã†ä¸€åº¦"
            onClick: @() {
              init()
            }
          })
        ]
        align: "center"
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
