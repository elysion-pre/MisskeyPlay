/// @ 0.19.0
// ãƒªãƒãƒ¼ã‚·ãƒ¬ã‚³ãƒ¼ãƒ‰
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/a103wpk0sp`
let PLAY_TAG = "#REVERSI_RECORD"

// ãƒªãƒãƒ¼ã‚·ãƒ‡ãƒ¼ã‚¿
@Reversi() {
  let this = {
    data: null
    last_id: ""
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    constructor: @() {
      this.data = null
      this.last_id = ""
//this.deleteData()
      // ãƒ­ãƒ¼ãƒ‰
      this.loadData()
      this
    }
    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
    deleteData: @() {
      Mk:save(`@{USER_ID}/reversi_data`, null)
      Mk:save(`@{USER_ID}/last_id`, null)
    }
    // ãƒ­ãƒ¼ãƒ‰
    loadData: @() {
      this.data = Mk:load(`@{USER_ID}/reversi_data`)
      this.last_id = Mk:load(`@{USER_ID}/last_id`)
      if this.last_id == null this.last_id = "0000000000"
    }
    // ã‚»ãƒ¼ãƒ–
    saveData: @() {
      Mk:save(`@{USER_ID}/reversi_data`, this.data)
      Mk:save(`@{USER_ID}/last_id`, this.last_id)
    }
    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹å¦ã‹
    // return <bool>
    isGameData: @() { if this.data.len == 0 return false else return true }
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    getData: @() { return this.data }
    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
    getGameData: @() {
      var games = []
      loop {
        let works = Mk:api("reversi/games", {
          limit: 100
          sinceId: this.last_id
        })
        if works.len == 0 break

        // ãƒ­ã‚»ã‚ªã€ãƒ«ãƒ¼ãƒ—ãƒœãƒ¼ãƒ‰ã€ã©ã“ã§ã‚‚ç½®ã‘ã‚‹ãƒ¢ãƒ¼ãƒ‰ã¯å¯¾è±¡å¤–
        games = games.concat(works.filter(@(i) {
          (i.user1Id == USER_ID || i.user2Id == USER_ID) && !i.isLlotheo && !i.canPutEverywhere && !i.loopedBoard && i.isEnded
        }))
        this.last_id = works[works.len - 1].id
        if (works.len < 100) break
      }
      // å–å¾—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
      if games.len > 0 {
        if this.data != null {
          this.data = this.data.concat(games)
        } else {
          this.data = games
        }
      }
      // ã‚»ãƒ¼ãƒ–
      this.saveData()
    }
  }
  this.constructor()
}

@Game() {
  // ãƒªãƒãƒ¼ã‚·
  var reversi = null
  // å¯¾æˆ¦ç›¸æ‰‹æƒ…å ±
  var match_users = []
  // è‰²æƒ…å ±
  let color = {
    win: "00cc00",
    lose: "cc0000",
    draw: "888888"
    border: "3c3c3c"
  }

  // åˆæœŸåŒ–
  @init() {
    reversi = null
    match_users = []
    
    if (USER_ID == null) {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :destroying_hisubway:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :kaikigenshou::bakuhatsu_sakananoonigiri:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {

      let loadMfm = []
      loadMfm.push([
        `$[x2 Now Loading]`
        `ãƒªãƒãƒ¼ã‚·ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
        `<small><small>â„¹ï¸ãƒ­ã‚»ã‚ªã€ãƒ«ãƒ¼ãƒ—ãƒœãƒ¼ãƒ‰ã€ã©ã“ã§ã‚‚ç½®ã‘ã‚‹ãƒ¢ãƒ¼ãƒ‰ã¯å¯¾è±¡å¤–</small></small>`
      ].join(Str:lf))

      reversi = Reversi()
      // ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸã‚‰åˆå›
      if reversi.getData() == null {
        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        loadMfm.push(`<small><small>âš ï¸åˆå›èª­ã¿è¾¼ã¿ã¯ã‚µãƒ¼ãƒãƒ¼å†…ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒå¤šã„ã»ã©æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</small></small>`)
      }

      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: loadMfm.join(Str:lf)
            })
          ]
          align: "center"
        })
      ])
      // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
      reversi.getGameData()

      // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸã‚‰
      if !reversi.isGameData() {
        render([
          Ui:C:container({
            children: [
              Ui:C:mfm({
                text: `$[x2 [ãƒªãƒãƒ¼ã‚·ã§éŠã¶]({SERVER_URL}/reversi)]`
              })
            ]
            align: "center"
          })
        ])
        Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
          `ãƒªãƒãƒ¼ã‚·ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
          `$[x2 :nai::kanashii_sakananoonigiri:]`
          `ãƒªãƒãƒ¼ã‚·ã‚’éŠã‚“ã§ã‹ã‚‰ãã¦ã­ãƒ¼ğŸ‘‹`
        ].join(Str:lf), "error")
      } else {
        main()
      }
    }
  }
  // å‹ç‡é–¢é€£ã®ãƒãƒ¼ä½œæˆ
  // param: rate_obj<obj>
  // return: <str>
  @createRateBarMfm(rate_obj) {
    let barWin = []
    let win = eval {
      var num = Math:round((rate_obj.win / rate_obj.match_num) * 100) / 10
      if num < 1 && num > 0 num = 1
      num
    }
    for win barWin.push("ã€€")

    let barLose = []
    let lose = eval {
      var num = Math:round((rate_obj.lose / rate_obj.match_num) * 100) / 10
      if num < 1 && num > 0 num = 1
      num
    }
    for lose barLose.push("ã€€")

    let barDraw = []
    let draw = eval {
      var num = Math:round((rate_obj.draw / rate_obj.match_num) * 100) / 10
      if num < 1 && num > 0 num = 1
      num
    }
    for draw barDraw.push("ã€€")

    let barMfm = eval {
      let mfm = [] 
      if barWin.len > 0 mfm.push(`$[bg.color={color.win} {barWin.join()}]`)
      if barLose.len > 0 mfm.push(`$[bg.color={color.lose} {barLose.join()}]`)
      if barDraw.len > 0 mfm.push(`$[bg.color={color.draw} {barDraw.join()}]`)
      mfm.join()
    }
    barMfm
  }
  // å¯¾æˆ¦ç›¸æ‰‹ã¨ã®æˆç¸¾
  // param: result_data<arr>
  // param: match_user_id<str>
  @matchResult(result_data, match_user_id) {
    // å¯¾æˆ¦ç›¸æ‰‹
    let match_user = match_users.filter(@(i) {
      i.id == match_user_id
    })
    // å¯¾æˆ¦ç›¸æ‰‹ã¨ã®æˆç¸¾
    let match_user_results = result_data.filter(@(i) {
      i.user1Id == match_user[0].id || i.user2Id == match_user[0].id
    })
    
    // æˆç¸¾è¡¨ç¤ºç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    let match_user_result_components = []
    each (let result, match_user_results) {
      let result_marks = []
      match result.winnerId {
        // å‹ã¡
        USER_ID => { result_marks.push(`$[border.radius=5 $[bg.color={color.win} $[fg.color=fff ï¼·]]]`) }
        // å¼•ãåˆ†ã‘
        null => { result_marks.push(`$[border.radius=5 $[bg.color={color.draw} $[fg.color=fff ï¼¤]]]`) }
        // è² ã‘
        * => { result_marks.push(`$[border.radius=5 $[bg.color={color.lose} $[fg.color=fff ï¼¬]]]`) }
      }
      let extra_marks = []
      // æŠ•äº†
      if result.surrenderedUserId == USER_ID {
        extra_marks.push("ğŸ³")
      }
      // æ™‚é–“åˆ‡ã‚Œ
      if result.timeoutUserId == USER_ID {
        extra_marks.push("â°")
      }
      // å„å¯¾æˆ¦ã¸ã®ãƒªãƒ³ã‚¯
      match_user_result_components.push(
        Ui:C:mfm({
          text: `<small>{result_marks.join()}[$[unixtime {Date:parse(result.createdAt) / 1000}]]({SERVER_URL}/reversi/g/{result.id}){extra_marks.join()}</small>`
        })
      )
    }
    let match_user_rate_obj = {
      win: match_user_results.filter(@(i) { i.winnerId == USER_ID }).len
      lose: match_user_results.filter(@(i) { i.winnerId != USER_ID && i.winnerId != null }).len
      draw: match_user_results.filter(@(i) { i.winnerId == null }).len
      surrender: match_user_results.filter(@(i) { i.winnerId != USER_ID && i.surrenderedUserId == USER_ID }).len
      timeout: match_user_results.filter(@(i) { i.winnerId != USER_ID && i.timeoutUserId == USER_ID }).len
      match_num: match_user_results.len
    }

    // å‹ç‡é–¢é€£ã®ãƒãƒ¼ä½œæˆ
    let barMfm = createRateBarMfm(match_user_rate_obj)

    let match_userMfm = eval {
      let name = if match_user[0].name == null match_user[0].username else match_user[0].name
      let url = if match_user[0].host == null `{SERVER_URL}/@{match_user[0].username}` else `https://{match_user[0].host}/@{match_user[0].username}`
      `?[<plain>{name}</plain>]({url})`
    }

    // çµæœè¡¨ç¤ºç”¨
    let user_resultMfm = [
      `{match_userMfm}ã¨ã®ãƒªãƒãƒ¼ã‚·æˆç¸¾`
      `{match_user_results.len}æˆ¦{match_user_rate_obj.win}å‹{match_user_rate_obj.lose}æ•—{match_user_rate_obj.draw}åˆ†ã‘`
      `$[border.width=2,radius=5,color={color.border},style=inset {barMfm}]`
      `å‹: {Math:round(match_user_rate_obj.win / match_user_results.len * 100)}%, è² : {Math:round(match_user_rate_obj.lose / match_user_results.len * 100)}%, åˆ†: {Math:round(match_user_rate_obj.draw / match_user_results.len * 100)}%`
      `<small>ğŸ³ï¸æŠ•äº†ã—ãŸæ•°: {match_user_rate_obj.surrender}`
      `â°æ™‚é–“åˆ‡ã‚Œæ•°: {match_user_rate_obj.timeout}</small>`
    ].join(Str:lf)

    // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    let user_postText = [
      `<center>`
      user_resultMfm
      PLAY_URL
      PLAY_TAG
      `</center>`
    ].join(Str:lf)

    match_user_result_components.unshift(
      Ui:C:container({
        children: [
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: user_postText
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
    )
    match_user_result_components.unshift(
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: `<small>{user_resultMfm}</small>`
          })
        ]
        align: "center"
      })
    )

    // å¯¾æˆ¦æˆç¸¾ã¨å±¥æ­´
    Ui:get("folder").update({
      children: [
        Ui:C:container({
          children: match_user_result_components
          align: "left"
        })
      ]
      title: `ğŸ†š@{match_user[0].username}({match_user_results.len})`
      opened: true
    })
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `å¯¾æˆ¦ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
          Ui:C:mfm({}, "reversi_data")
        ]
        align: "center"
      })
    ])

    let reversi_data = reversi.getData()
    let result_data = []
    for (let i = 0, reversi_data.len) {
      // ä½œæ¥­ä¸­UIæ›´æ–°
      Ui:get("reversi_data").update({
        text: `{i + 1}/{reversi_data.len}`
      })
      // å¯¾æˆ¦ç›¸æ‰‹ã®æƒ…å ±
      let match_user = {
        id: if (reversi_data[i].user1Id != USER_ID) reversi_data[i].user1.id else reversi_data[i].user2.id
        name: if (reversi_data[i].user1Id != USER_ID) reversi_data[i].user1.name else reversi_data[i].user2.name
        username: if (reversi_data[i].user1Id != USER_ID) reversi_data[i].user1.username else reversi_data[i].user2.username
        host: if (reversi_data[i].user1Id != USER_ID) reversi_data[i].user1.host else reversi_data[i].user2.host
      }
      // é‡è¤‡ã—ã¦ã„ãŸã‚‰æ›´æ–°ã®ãŸã‚é™¤å¤–
      match_users = match_users.filter(@(i) {
        i.id != match_user.id
      })
      // è¿½åŠ 
      match_users.push(match_user)

      result_data.push(reversi_data[i])
    }
    match_users.reverse()
    result_data.reverse()

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `å¯¾æˆ¦ç›¸æ‰‹ã¨ã®æˆç¸¾ä½œæˆä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
          Ui:C:mfm({}, "match_data")
        ]
        align: "center"
      })
    ])
    
    // å¯¾æˆ¦ç›¸æ‰‹ã®é¸æŠè‚¢ä½œæˆ
    let match_user_items = []
    for (let i = 0, match_users.len) {
      // ä½œæ¥­ä¸­UIæ›´æ–°
      Ui:get("match_data").update({
        text: `{i + 1}/{match_users.len}`
      })
      // å¯¾æˆ¦ç›¸æ‰‹ã¨ã®å¯¾æˆ¦æ•°
      let user_match_num = result_data.filter(@(idx) {
        idx.user1Id == match_users[i].id || idx.user2Id == match_users[i].id
      }).len

      match_user_items.push({
        text: `ğŸ†š@{match_users[i].username}({user_match_num})`
        value: match_users[i].id
      })
    }

    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              `$[x2 Now Loading]`
              `{if USER_NAME != null USER_NAME else USER_USERNAME}ã®ç·åˆæˆç¸¾ä½œæˆä¸­$[bounce .]$[bounce.delay=0.2s .]$[bounce.delay=0.4s .]`
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
    ])

    let rate_obj = {
      win: result_data.filter(@(i) { i.winnerId == USER_ID }).len
      lose: result_data.filter(@(i) { i.winnerId != USER_ID && i.winnerId != null }).len
      draw: result_data.filter(@(i) { i.winnerId == null }).len
      surrender: result_data.filter(@(i) { i.winnerId != USER_ID && i.surrenderedUserId == USER_ID }).len
      timeout: result_data.filter(@(i) { i.winnerId != USER_ID && i.timeoutUserId == USER_ID }).len
      match_num: result_data.len
    }
    // å‹ç‡é–¢é€£ã®ãƒãƒ¼ä½œæˆ
    let barMfm = createRateBarMfm(rate_obj)

    let userMfm = eval {
      let name = if USER_NAME != null USER_NAME else USER_USERNAME
      let url = `{SERVER_URL}/@{USER_USERNAME}`
      `?[<plain>{name}</plain>]({url})`
    }

    // çµæœè¡¨ç¤ºç”¨
    let resultMfm = [
      `{userMfm}ã®ãƒªãƒãƒ¼ã‚·æˆç¸¾`
      `{result_data.len}æˆ¦{rate_obj.win}å‹{rate_obj.lose}æ•—{rate_obj.draw}åˆ†ã‘`
      `$[border.width=2,radius=5,color={color.border},style=inset {barMfm}]`
      `å‹: {Math:round(rate_obj.win / result_data.len * 100)}%, è² : {Math:round(rate_obj.lose / result_data.len * 100)}%, åˆ†: {Math:round(rate_obj.draw / result_data.len * 100)}%`
      `<small>ğŸ³ï¸æŠ•äº†ã—ãŸæ•°: {rate_obj.surrender}`
      `â°æ™‚é–“åˆ‡ã‚Œæ•°: {rate_obj.timeout}</small>`
    ].join(Str:lf)

    // æŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    let postText = [
      `<center>`
      resultMfm
      PLAY_URL
      PLAY_TAG
      `</center>`
    ].join(Str:lf)
    
    render([
      Ui:C:container({
        children: [
          Ui:C:mfm({
            text: [
              resultMfm
            ].join(Str:lf)
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:postFormButton({
            text: "æŠ•ç¨¿ã™ã‚‹"
            form: {
              text: postText
            }
            primary: true
            rounded: true
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:select({
            items: match_user_items
            onChange: @(value) {
              matchResult(result_data, value)
            }
            label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ"
            caption: "é¸æŠã™ã‚‹ã¨å¯¾æˆ¦æˆç¸¾ã¨å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™"
          })
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:folder({
            title: "å¯¾æˆ¦æˆç¸¾ã¨å±¥æ­´"
            opened: true
          }, "folder")
        ]
        align: "center"
      })
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:button({
                text: "å‰Šé™¤"
                onClick: @() {
                  if Mk:confirm("ç¢ºèª", [
                    "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                    "$[x2 :majikaw::mimi_hate:]"
                  ].join(Str:lf), "warning") {
                    reversi.deleteData()
                    Mk:dialog("å®Œäº†", [
                      "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
                      "$[x2 :orenitehakaizumi::mimi_hate:]"
                    ].join(Str:lf))
                  }
                }
              })
              Ui:C:mfm({
                text: [
                  `<small>âš ï¸ãƒªãƒãƒ¼ã‚·ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“</small>`
                ].join(Str:lf)
              })
            ]
            title: "Playå†…ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤"
            opened: false
          })
        ]
        align: "center"
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
