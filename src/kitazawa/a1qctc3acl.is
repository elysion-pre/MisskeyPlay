/// @ 0.19.0
// å‰å¾Œã®ãƒãƒ¼ãƒˆ
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

// description:
// ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«é–¢ã—ã¦
// ä¸‹è¨˜å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§
// https://misskey-hub.net/ja/docs/for-developers/api/token/

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/a1qctc3acl`
let PLAY_ID = if exists THIS_ID THIS_ID else PLAY_URL

@Game() {
  var input_id = ""
  // ãƒˆãƒ¼ã‚¯ãƒ³
  var token = null
  var note = null
  var fReplies = true

  // åˆæœŸåŒ–
  @init() {
    input_id = ""
    token_check()
  }
  // æŠ•ç¨¿ç¯„å›²ã®è‰²
  // param: visibility<str>
  // return: <str>
  @getNoteVisibiltyColor(visibility) {
    var ret = ""
    match visibility {
      "public" => { ret = "00008b" }
      "home" => { ret = "006400" }
      "followers" => { ret = "8b0000" }
      "specified" => { ret = "556b2f" }
    }
    ret
  }
  // ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª
  @token_check() {
    token = Mk:load(`@{USER_ID}/{PLAY_ID}/token`)
//<:`token: {token}`
    if (token != null && token != "") {
      render([
        Ui:C:folder({
          children: [
            Ui:C:container({
              children: [
                Ui:C:textInput({
                  onInput: @(text) {
                    input_id = text
                  }
                  default: input_id
                  label: "ãƒãƒ¼ãƒˆURL"
                  caption: "âš ãƒãƒ¼ãƒˆURLç¢ºèªæ–¹æ³•: ãƒãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼"
                })
                Ui:C:switch({
                  onChange: @(enabled) {
                    fReplies = enabled
                  }
                  default: fReplies
                  label: "ãƒªãƒ—ãƒ©ã‚¤ã‚’å«ã‚ã‚‹"
                  caption: "âš ï¸OFFã«ã™ã‚‹ã¨ãƒªãƒ—ãƒ©ã‚¤ã¯é™¤å¤–"
                })
                Ui:C:buttons({
                  buttons: [
                    {
                      text: "æ¤œç´¢ã™ã‚‹(HTL)"
                      onClick: @() {
                        if input_id != "" {
                          input_id = input_id.split("/").pop()
                          note = Mk:api("notes/show", { noteId: input_id }, token)
                          match Core:type(note) {
                            "error" => { Mk:dialog("error", `ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`) }
                            "obj" => { main("HTL") }
                          }
                        }
                      }
                    },
                    {
                      text: "æ¤œç´¢ã™ã‚‹(LTL)"
                      onClick: @() {
                        if input_id != "" {
                          input_id = input_id.split("/").pop()
                          note = Mk:api("notes/show", { noteId: input_id }, token)
                          match Core:type(note) {
                            "error" => { Mk:dialog("error", `ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`) }
                            "obj" => { main("LTL") }
                          }
                        }
                      }
                    },
                    {
                      text: "æ¤œç´¢ã™ã‚‹(STL)"
                      onClick: @() {
                        if input_id != "" {
                          input_id = input_id.split("/").pop()
                          note = Mk:api("notes/show", { noteId: input_id }, token)
                          match Core:type(note) {
                            "error" => { Mk:dialog("error", `ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`) }
                            "obj" => { main("STL") }
                          }
                        }
                      }
                    }
                  ]
                })
              ]
              align: "center"
            })
          ]
          title: "æŒ‡å®šã®ãƒãƒ¼ãƒˆã®å‰å¾Œã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³"
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
                    `ã€€æœ¬Playã®ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `3.å‰Šé™¤`
                    `ã€€ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€ğŸ—‘ï¸(ã‚´ãƒŸç®±)ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€å‰Šé™¤å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤æ‰‹é †"
              opened: true
            })
          ]
          bgColor: "#ba8b55" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "dashed" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
        Ui:C:container({
          children: [
            Ui:C:button({
              text: `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
              onClick: @() {
                Mk:save(`@{USER_ID}/{PLAY_ID}/token`, null)
                Mk:dialog("å®Œäº†", [
                  `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`
                  `$[x2 :orenitehakaizumi::mimi_hate:]`
                ].join(Str:lf), "success")
                token_check()
              }
            })
          ]
          align: "center"
        })
      ])
    } else {
      render([
        Ui:C:container({
          children: [
            Ui:C:textInput({
              onInput: @(text) {
                token = text
              }
              default: ""
              label: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            })
            Ui:C:button({
              text: `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜`
              onClick: @() {
                if (token != null && token != "") {
                  Mk:save(`@{USER_ID}/{PLAY_ID}/token`, token)
                  Mk:dialog("å®Œäº†", [
                    `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ`
                    `$[x2 :orenitekaishuzumi::mimi_heart:]`
                    `<small>âš ï¸ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä»–äººã«çŸ¥ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„</small>`
                  ].join(Str:lf), "success")
                  token_check()
                }
              }
            })
          ]
          align: "center"
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.åå‰`
                    `ã€€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®åå‰ã‚’å…¥åŠ›`
                    `3.æ¨©é™`
                    `ã€€ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æƒ…å ±ã‚’è¦‹ã‚‹ã€‘ã‚’æœ‰åŠ¹ã«`
                    `4.ç™ºè¡Œ`
                    `ã€€å³ä¸Šã®ã€âœ”ï¸ã€‘ã‚’æŠ¼ä¸‹ã—ç™ºè¡Œ`
                    `ã€€ç¢ºèªã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã‚³ãƒ”ãƒ¼`
                    `5.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜`
                    `ã€€æœ¬Playã«ãƒšãƒ¼ã‚¹ãƒˆã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€ä¿å­˜å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆãƒ»ä¿å­˜æ‰‹é †"
              opened: true
            })
          ]
          bgColor: "#89e555" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "solid" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
        Ui:C:container({
          children: [
            Ui:C:folder({
              children: [
                Ui:C:mfm({
                  text: [
                    `1.ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤`
                    `ã€€æœ¬Playã®ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `2.[è¨­å®š->API]({SERVER_URL}/settings/api)`
                    `ã€€ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹`
                    `3.å‰Šé™¤`
                    `ã€€ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€ğŸ—‘ï¸(ã‚´ãƒŸç®±)ã€‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€å‰Šé™¤å®Œäº†`
                  ].join(Str:lf)
                })
              ]
              title: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤æ‰‹é †"
              opened: false
            })
          ]
          bgColor: "#ba8b55" // èƒŒæ™¯è‰²
          borderColor: "#000" // æ ã®è‰²
          borderStyle: "dashed" // æ ã®æŸ„
          padding: 2 // ä½™ç™½å¹…
          rounded: true // è§’ã‚’ä¸¸ã
        })
      ])
    }
  }
  // ãƒãƒ¼ãƒˆå†…å®¹ã‚’ã„ã„æ„Ÿã˜ã«ã—ã¦è¿”ã™
  // param: notes<arr>
  // return: <str>
  @getResults(notes) {
    let results = []
    each (let note, notes) {
      let data = []
      if note.renoteId != null {
        data.push(`<small>@{note.user.username}{if note.user.host != null `@{note.user.host}` else ""}ãŒãƒªãƒãƒ¼ãƒˆ</small>`)
        if note.text != null data.push(`{note.text}`)
        data.push(`@{note.renote.user.username}{if note.renote.user.host != null `@{note.renote.user.host}` else ""}`)
        data.push(`{note.renote.text}`)
      } else if note.replyId != null {
        data.push(`<small>@{note.user.username}{if note.user.host != null `@{note.user.host}` else ""}ãŒãƒªãƒ—ãƒ©ã‚¤</small>`)
        if note.text != null data.push(`{note.text}`)
      } else {
        data.push(`<small>@{note.user.username}{if note.user.host != null `@{note.user.host}` else ""}ãŒãƒãƒ¼ãƒˆ</small>`)
        if note.text != null data.push(`{note.text}`)
      }
      if note.files.len > 0 {
        each (let file, note.files) {
          data.push(`{file.url}`)
        }
      }
      data.push(`[$[unixtime {(Date:parse(note.createdAt) / 1000)}]]({SERVER_URL}/notes/{note.id})`)
      results.push(`$[border.width=2,radius=5,color={getNoteVisibiltyColor(note.visibility)} {data.join(Str:lf)}]{Str:lf}`)
    }
    results.join(Str:lf)
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main(tl_type) {
    var until_notes = null
    let until_param = {
      limit: 100,
      untilId: input_id,
      allowPartial: true,
      includeMyRenotes: true,
      includeRenotedMyNotes: true,
      includeLocalRenotes: true,
      withReplies: fReplies
    }
    var since_notes = null
    let since_param = {
      limit: 100,
      sinceId: input_id,
      allowPartial: true,
      includeMyRenotes: true,
      includeRenotedMyNotes: true,
      includeLocalRenotes: true,
      withReplies: fReplies
    }

    match tl_type {
      "HTL" => {
        until_notes = Mk:api("notes/timeline", until_param, token)
        until_notes.reverse()
        since_notes = Mk:api("notes/timeline", since_param, token)
      }
      "LTL" => {
        until_notes = Mk:api("notes/local-timeline", until_param, token)
        until_notes.reverse()
        since_notes = Mk:api("notes/local-timeline", since_param, token)
      }
      "STL" => {
        until_notes = Mk:api("notes/hybrid-timeline", until_param, token)
        until_notes.reverse()
        since_notes = Mk:api("notes/hybrid-timeline", since_param, token)
      }
    }

    render([
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:mfm({
                    text: getResults(until_notes)
                  })
                ]
                align: "left"
              })
            ]
            title: `100ä»¶å‰ã®{tl_type}`
            opened: false
          })
        ]
        bgColor: "#f001" // èƒŒæ™¯è‰²
        borderColor: "#f00" // æ ã®è‰²
        borderStyle: "solid" // æ ã®æŸ„
        padding: 2 // ä½™ç™½å¹…
        rounded: true // è§’ã‚’ä¸¸ã
      })

      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:mfm({
                    text: getResults([note])
                  })
                ]
                align: "left"
              })
            ]
            title: "å…ƒãƒãƒ¼ãƒˆ"
          })
        ]
        bgColor: "#0f01" // èƒŒæ™¯è‰²
        borderColor: "#0f0" // æ ã®è‰²
        borderStyle: "solid" // æ ã®æŸ„
        padding: 2 // ä½™ç™½å¹…
        rounded: true // è§’ã‚’ä¸¸ã
      })
      Ui:C:container({
        children: [
          Ui:C:folder({
            children: [
              Ui:C:container({
                children: [
                  Ui:C:mfm({
                    text: getResults(since_notes)
                  })
                ]
                align: "left"
              })
            ]
            title: `100ä»¶å¾Œã®{tl_type}`
          })
        ]
        bgColor: "#00f1" // èƒŒæ™¯è‰²
        borderColor: "#00f" // æ ã®è‰²
        borderStyle: "solid" // æ ã®æŸ„
        padding: 2 // ä½™ç™½å¹…
        rounded: true // è§’ã‚’ä¸¸ã
      })
    ])
  }
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
