/// @ 0.18.0
// ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS
// Copyright (c) 2024 @elysion
// License: MIT License
// https://github.com/elysion-pre/MisskeyPlay/blob/main/LICENSE

let PLAY_NAME = "ï½±ï¾‚ï½±ï¾‚ã®ğŸ˜šâ¤ï¸KISS"
let TAG_NAME = "#KITAZAWA_AI"
let PLAY_URL = if exists THIS_URL THIS_URL else "https://msk.kitazawa.me/play/9rneqzbgn8"

:: Arr {
  // ãƒ©ãƒ³ãƒ€ãƒ ã§é…åˆ—ã®å€¤ã‚’è¿”ã™
  // param: array<arr>
  // return: <arr[0~(arr.len - 1)]>
  @randomSelect(array) {
    array[random(0, (array.len - 1))]
  }
  // æŒ‡å®šã®é…åˆ—ã‚’å‰Šé™¤ã—ãŸé…åˆ—ã‚’è¿”ã™
  // param: array<arr>
  // param: index<num>
  // return: <arr>
  @splice(array, index) {
    array.slice(0, index).concat(array.slice((index + 1), array.len))
  }
}

:: Ui {
  // æŒ‡å®šUIã®hiddenå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @hidden(name, f) {
    Ui:get(name).update({
      hidden: f
    })
  }
  // æŒ‡å®šUIã®disabledå‡¦ç†
  // param: name<str>
  // param: f<bool>
  @disabled(name, f) {
    Ui:get(name).update({
      disabled: f
    })
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
// param: id<str>
@User(id) {
  let this = {
    data: null
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    // param: id<str>
    constructor: @(id) {
      this.data = Mk:api("users/show", {
        userId: id
      })
      this
    }
    // idå–å¾—
    // return: id<str>
    getId: @() {
      this.data.id
    }
    // hostå–å¾—
    // return: host<str>
    getHost: @() {
      this.data.host
    }
    // åå‰å–å¾—
    // return: username<str>
    getUsername: @() {
      this.data.username
    }
    // åå‰å–å¾—
    // return: name<str>
    getName: @() {
      // åå‰ãŒæœªå…¥åŠ›ãªã‚‰username(@hoge)ã‚’è¿”ã™
      if (this.data.name == null) {
        return this.getUsername()
      }
      return this.data.name
    }
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³åå–å¾—(@username@host)
    // return: name<str>
    getMentionName: @() {
      match this.getHost() {
        null => { return `@{this.getUsername()}` }
        * => { return `@{this.getUsername()}@{this.getHost()}` }
      }
    }
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLå–å¾—
    // return: name<str>
    getProfileURL: @() {
      match this.getHost() {
        null => { return `{SERVER_URL}/@{this.getUsername()}` }
        * => { return `https://{this.getHost()}/@{this.getUsername()}` }
      }
    }
    // idãŒè‡ªåˆ†ã‹ã©ã†ã‹
    // param: id<str>
    // return: f<bool>
    isYourself: @(id) {
      if (this.data.id == id) {
        return true
      } else {
        return false
      }
    }
  }
  this.constructor(id)
}

@Game() {
  var player = null
  var input_id = if exists USER_ID USER_ID else ""

  // å…¥åŠ›å‡¦ç†
  @input() {
    // UIæ›´æ–°å‡¦ç†
    Ui:get("inputText").update({
      onInput: @(text) {
        input_id = text
      }
      default: input_id
      label: "idã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
      caption: "âš idã¯æœ¬ãƒ›ã‚¹ãƒˆ(ããŸã–ã‚ã¿ã™ã)ã‹ã‚‰è¦‹ãŸidã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚"
    })

    Ui:get("checkButton").update({
      text: "ç¢ºèªã™ã‚‹"
      onClick: @() {
        let user = User(input_id)
        if (user != null) {
          Ui:get("titleMfm").update({
            text: `$[x2 {user.getName()}ã®{PLAY_NAME}ã¯]`
          })

          Ui:get("userInfoMfm").update({
            text: [
              `name: {user.getName()}`
              `username: {user.getMentionName()}`
            ].join(Str:lf)
          })
          Ui:disabled("execButton", false)
        }
      }
    })

    Ui:get("userInfoMfm").update({
      text: "user data"
    })

    Ui:get("execButton").update({
      text: "å®Ÿè¡Œã™ã‚‹"
      onClick: @() {
        let user = User(input_id)
        if (user != null) {
          player = user
          Ui:hidden("input_area", true)
          init()
        } else {
          Mk:dialog("", "error")
        }
      }
    })
    Ui:hidden("loading_area", true)
    Ui:hidden("input_area", false)
    Ui:hidden("main_area", true)
    Ui:hidden("post_area", true)
    Ui:disabled("execButton", true)
  }
  // ã‚‚ã†ä¸€åº¦
  @replay() {
    // æŠ¼ã›ãªãã—ã¦ãŠã
    Ui:disabled("replayButton", true)
    input()
  }
  // åˆæœŸåŒ–
  @init() {
    // UIæ›´æ–°å‡¦ç†
    Ui:get("titleMfm").update({
      text: `$[x2 {player.getName()}ã®{PLAY_NAME}ã¯]`
    })

    Ui:get("replayButton").update({
      text: "ã‚‚ã†ä¸€åº¦"
      onClick: @() {
        replay()
      }
      disabled: true
    })

    Ui:hidden("loading_area", false)
    Ui:hidden("input_area", true)
    Ui:hidden("main_area", true)
    Ui:hidden("post_area", true)

    start()
  }
  // å‡¦ç†é–‹å§‹
  @start() {
    // api: users/get-frequently-replied-users
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé »ç¹ã«ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚æœ€æ–°ã®1000ä»¶ã®ãƒãƒ¼ãƒˆã‚’å¯¾è±¡ã«é›†è¨ˆã‚’è¡Œã„ã¾ã™ã€‚
    // https://legacy.misskey-hub.net/docs/api/endpoints/users/get-frequently-replied-users.html
    let replied_users = Mk:api("users/get-frequently-replied-users", {
      userId: player.getId(),
      limit: 11
    })
    let rank_emoji = [
      "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ"
    ]
    var count = 0
    let user_list = []
    if (replied_users.len > 0) {
      each (let ru, replied_users) {
        if ru.user.isSuspended continue

        let data = []
        let replied_user = User(ru.user.id)
        // è‡ªèº«ã¯é™¤å¤–
        if ((!player.isYourself(replied_user.getId())) && (count < 10)) {
          data.push(`{rank_emoji[count]}: `)
          if (count == 0) {
            data.push("$[jelly ")
          }
          data.push(`?[{replied_user.getName()}]({replied_user.getProfileURL()})`)
          if (count == 0) {
            data.push("]")
          }
          user_list.push(data.join())
          count += 1
        }
      }
      // çµæœè¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let resultMfm = [
        user_list.join(Str:lf)
      ].join(Str:lf)

      // çµæœè¡¨ç¤ºUIæ›´æ–°
      Ui:get("resultMfm").update({
       text: resultMfm
      })

      Ui:hidden("loading_area", true)
      Ui:hidden("main_area", false)
      Ui:hidden("post_area", false)
      Ui:get("replayButton").update({
        disabled: false
      })
    } else {
      // çµæœè¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
      let resultMfm = [
        "<center>"
        "âš ç›´è¿‘1000ä»¶ã®ãƒãƒ¼ãƒˆå†…ã«ãƒªãƒ—ãƒ©ã‚¤ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        "</center>"
      ].join(Str:lf)

      // çµæœè¡¨ç¤ºUIæ›´æ–°
      Ui:get("resultMfm").update({
        text: resultMfm
      })

      Ui:hidden("loading_area", true)
      Ui:hidden("main_area", false)
      Ui:get("replayButton").update({
        disabled: false
      })
    }
  }
  input()
}

Ui:render([
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 {PLAY_NAME}]`
      }, "titleMfm")
    ]
    align: "center"
  }, "title_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({
        text: `$[x2 $[bounce Now Loading...]]`
      }, "loadingMfm")
    ]
    align: "center"
  } "loading_area")
  Ui:C:container({
    children: [
      Ui:C:textInput({}, "inputText")
      Ui:C:button({}, "checkButton")
      Ui:C:mfm({}, "userInfoMfm")
      Ui:C:button({}, "execButton")
    ]
    align: "center"
    hidden: true
  }, "input_area")
  Ui:C:container({
    children: [
      Ui:C:mfm({}, "resultMfm")
    ]
//    align: "center"
    hidden: true
  }, "main_area")
  Ui:C:container({
    children: [
      Ui:C:button({} "replayButton")
    ]
    align: "center"
    hidden: true
  }, "post_area")
])
Game()
