/// @ 0.19.0
// ã‚ãªãŸã®æˆ¦é—˜åŠ›
// Copyright (c) 2024 @elysion
// This script is licensed under the MIT
// https://opensource.org/licenses/mit-license.php

let PLAY_URL = if exists THIS_URL THIS_URL else `{SERVER_URL}/play/9v7lf1q091`
let PLAY_TAG = "#è‡ªåˆ†ã®æˆ¦é—˜åŠ›ä¸Šã’ã¦ã‘"

@Game() {

  // åˆæœŸåŒ–
  @init() {

    if (USER_ID == null) {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog("ã‚¨ãƒ©ãƒ¼", [
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`
        `$[x2 :fushiginakotomoarumondesuna::mimi_hate:]`
        `ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰éŠã‚“ã§ã¿ã¦ã­ãƒ¼ğŸ‘‹`
      ].join(Str:lf), "error")
    } else {
      main()
    }
  }
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  @main() {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—
    let user = Mk:api("users/show", {
      userId: USER_ID
    })
    
    if Core:type(user) == "error" {
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: `$[x4 :GoBack:]`
            })
          ]
          align: "center"
        })
      ])
      Mk:dialog(user.name, "ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", "error")
    } else {
      let archivements = Mk:api("users/achievements", {
        userId: user.id
      })
      
      let note_score = Math:floor(user.notesCount * 0.1)
      let ff_score = ((user.followersCount - user.followingCount) * 10)
      let days_score = (Math:floor((Date:now() - Date:parse(user.createdAt)) / 86400000) * 100)
      let archivements_score = (archivements.len * 50)
      let power = note_score + ff_score + days_score + archivements_score
      
      let resultMfm = [
       `$[fg.color=f00 ***{power}***]`
      ].join(Str:lf)
      
      let infoMfm = [
        `<small><small>`
        `ã‚¹ã‚³ã‚¢1: ãƒãƒ¼ãƒˆæ•°({user.notesCount}) Ã— 0.1 = $[fg.color=f00 {note_score}]`
        `ã‚¹ã‚³ã‚¢2: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°({user.followersCount}) - ãƒ•ã‚©ãƒ­ãƒ¼æ•°({user.followingCount}) Ã— 10 = $[fg.color=f00 {ff_score}]`
        `ã‚¹ã‚³ã‚¢3: å§‹ã‚ã¦ä½•æ—¥({Math:floor((Date:now() - Date:parse(user.createdAt)) / 86400000)}) Ã— 100 = $[fg.color=f00 {days_score}]`
        `ã‚¹ã‚³ã‚¢4: [å®Ÿç¸¾]({SERVER_URL}/my/achievements)è§£é™¤æ•°({archivements.len}) Ã— 50 = $[fg.color=f00 {archivements_score}]`
        `æˆ¦é—˜åŠ›: {note_score} + {ff_score} + {days_score} + {archivements_score} = {power}`
        `</small></small>`
      ].join(Str:lf)
      
      render([
        Ui:C:container({
          children: [
            Ui:C:mfm({
              text: resultMfm
            })
            Ui:C:mfm({
              text: infoMfm
            })
            Ui:C:postFormButton({
              text: "æŠ•ç¨¿ã™ã‚‹"
              form: {
                text: [
                  `<center>`
                  resultMfm
                  PLAY_URL
                  PLAY_TAG
                  `</center>`
                ].join(Str:lf)
              }
              primary: true
              rounded: true
            })
          ]
          align: "center"
        })
      ])
    }
  }
  // æç”»
  // param: components<arr>
  @render(components) {
    Ui:render(components)
  }
  init()
}
Game()
